<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIESTA - Food Delivery</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-primary: #121212;
            --bg-secondary: #1e1e1e;
            --bg-tertiary: #2d2d2d;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --accent: #ff6b35;
            --success: #4caf50;
            --danger: #f44336;
            --border: #404040;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            padding-top: 60px;
            padding-bottom: 120px;
            min-height: 100vh;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            padding: 15px;
            z-index: 1000;
            border-bottom: 1px solid var(--border);
        }

        .search-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .search-input {
            flex: 1;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 25px;
            padding: 12px 20px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .search-input::placeholder {
            color: var(--text-secondary);
        }

        .filter-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-primary);
            font-size: 18px;
        }

        /* Categories */
        .categories {
            padding: 15px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            z-index: 999;
            overflow-x: auto;
            white-space: nowrap;
        }

        .categories::-webkit-scrollbar {
            display: none;
        }

        .category-list {
            display: flex;
            gap: 10px;
        }

        .category-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 8px 16px;
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .category-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        /* Food Grid */
        .food-grid {
            padding: 15px;
            margin-top: 120px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px;
        }

        .food-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .food-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow);
        }

        .food-image {
            width: 100%;
            height: 120px;
            background: linear-gradient(45deg, var(--bg-tertiary), var(--border));
            position: relative;
            overflow: hidden;
        }

        .food-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .food-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--accent);
            color: white;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
        }

        .food-info {
            padding: 12px;
        }

        .food-name {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-primary);
        }

        .food-desc {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            height: 36px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .food-bottom {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .food-price {
            font-size: 16px;
            font-weight: bold;
            color: var(--accent);
        }

        .food-rating {
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .add-btn {
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        .add-btn:hover {
            opacity: 0.9;
        }

        .add-btn.added {
            background: var(--success);
        }

        /* Cart */
        .cart {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            padding: 15px;
            z-index: 1001;
            transform: translateY(100%);
            transition: transform 0.3s;
        }

        .cart.open {
            transform: translateY(0);
        }

        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .cart-title {
            font-size: 18px;
            font-weight: 600;
        }

        .cart-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
        }

        .cart-items {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-name {
            font-size: 14px;
            font-weight: 500;
        }

        .cart-item-price {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .cart-item-qty {
            min-width: 30px;
            text-align: center;
            font-weight: 600;
        }

        .cart-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cart-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: 600;
        }

        .checkout-btn {
            width: 100%;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        .checkout-btn:hover:not(:disabled) {
            opacity: 0.9;
        }

        .checkout-btn:disabled {
            background: var(--text-secondary);
            cursor: not-allowed;
        }

        /* Floating Cart */
        .floating-cart {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--accent);
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow);
            z-index: 999;
            transition: transform 0.3s;
        }

        .floating-cart:hover {
            transform: scale(1.1);
        }

        .cart-icon {
            font-size: 24px;
            margin-bottom: 2px;
        }

        .cart-count {
            font-size: 12px;
            font-weight: bold;
        }

        /* Filter Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .modal-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }

        .filter-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .filter-option {
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            color: var(--text-primary);
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .filter-option:hover {
            border-color: var(--accent);
        }

        .filter-option.active {
            border-color: var(--accent);
            background: rgba(255, 107, 53, 0.1);
        }

        /* Checkout Modal */
        .checkout-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .form-input {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            color: var(--text-primary);
            font-size: 16px;
        }

        .form-input::placeholder {
            color: var(--text-secondary);
        }

        .location-btn {
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 10px 0;
        }

        .location-btn:disabled {
            background: var(--text-secondary);
            cursor: not-allowed;
        }

        .location-status {
            font-size: 14px;
            color: var(--text-secondary);
            text-align: center;
            margin: 10px 0;
        }

        .promo-section {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }

        .promo-input {
            flex: 1;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            color: var(--text-primary);
            font-size: 16px;
        }

        .apply-promo-btn {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px 20px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 14px;
        }

        .promo-success {
            color: var(--success);
            font-size: 14px;
            text-align: center;
            margin: 5px 0;
        }

        .promo-error {
            color: var(--danger);
            font-size: 14px;
            text-align: center;
            margin: 5px 0;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        .modal-btn.cancel {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .modal-btn.submit {
            background: var(--accent);
            color: white;
        }

        .modal-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Loading */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Error State */
        .error-state {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            text-align: center;
            z-index: 3000;
        }

        .error-icon {
            font-size: 64px;
            margin-bottom: 20px;
            color: var(--danger);
        }

        .error-title {
            font-size: 24px;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .error-message {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .retry-btn {
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 3px;
        }

        /* Responsive */
        @media (max-width: 480px) {
            .food-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }
            
            .modal {
                width: 95%;
                padding: 20px;
            }
        }

        /* Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .food-card {
            animation: fadeIn 0.3s ease-out;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div>–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–Ω—é...</div>
    </div>

    <!-- Error State (hidden by default) -->
    <div class="error-state" id="errorState" style="display: none;">
        <div class="error-icon">‚ö†Ô∏è</div>
        <div class="error-title">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>
        <div class="error-message" id="errorMessage"></div>
        <button class="retry-btn" id="retryBtn">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
    </div>

    <!-- Main App Content -->
    <div id="appContent" style="display: none;">
        <!-- Header -->
        <div class="header">
            <div class="search-container">
                <input type="text" class="search-input" placeholder="–ü–æ–∏—Å–∫ –±–ª—é–¥..." id="searchInput">
                <div class="filter-btn" id="filterBtn">
                    ‚öôÔ∏è
                </div>
            </div>
        </div>

        <!-- Categories -->
        <div class="categories">
            <div class="category-list" id="categoryList">
                <!-- Categories will be loaded here -->
            </div>
        </div>

        <!-- Food Grid -->
        <div class="food-grid" id="foodGrid">
            <!-- Food items will be loaded here -->
        </div>

        <!-- Floating Cart -->
        <div class="floating-cart" id="floatingCart" style="display: none;">
            <div class="cart-icon">üõí</div>
            <div class="cart-count" id="cartCount">0</div>
        </div>

        <!-- Cart Sidebar -->
        <div class="cart" id="cart">
            <div class="cart-header">
                <div class="cart-title">–í–∞—à –∑–∞–∫–∞–∑</div>
                <button class="cart-close" id="cartClose">√ó</button>
            </div>
            <div class="cart-items" id="cartItems">
                <!-- Cart items will be loaded here -->
            </div>
            <div class="cart-total">
                <span>–ò—Ç–æ–≥–æ:</span>
                <span id="cartTotal">0</span> —Å—É–º
            </div>
            <button class="checkout-btn" id="checkoutBtn" disabled>–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
        </div>

        <!-- Filter Modal -->
        <div class="modal-overlay" id="filterModal">
            <div class="modal">
                <div class="modal-title">–§–∏–ª—å—Ç—Ä—ã</div>
                <div class="filter-options">
                    <div class="filter-option" data-filter="rating">–ü–æ —Ä–µ–π—Ç–∏–Ω–≥—É</div>
                    <div class="filter-option" data-filter="new">–ù–æ–≤—ã–µ</div>
                    <div class="filter-option" data-filter="price_asc">–°–Ω–∞—á–∞–ª–∞ –¥–µ—à–µ–≤—ã–µ</div>
                    <div class="filter-option" data-filter="price_desc">–°–Ω–∞—á–∞–ª–∞ –¥–æ—Ä–æ–≥–∏–µ</div>
                </div>
            </div>
        </div>

        <!-- Checkout Modal -->
        <div class="modal-overlay" id="checkoutModal">
            <div class="modal">
                <div class="modal-title">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</div>
                <form class="checkout-form" id="checkoutForm">
                    <div class="form-group">
                        <label class="form-label">–ò–º—è</label>
                        <input type="text" class="form-input" id="customerName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                        <input type="tel" class="form-input" id="customerPhone" placeholder="+998 __ ___ __ __" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É</label>
                        <textarea class="form-input" id="customerComment" rows="3" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –±–µ–∑ –ª—É–∫–∞, —Å–æ—É—Å –æ—Ç–¥–µ–ª—å–Ω–æ"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">–ü—Ä–æ–º–æ–∫–æ–¥ (–µ—Å–ª–∏ –µ—Å—Ç—å)</label>
                        <div class="promo-section">
                            <input type="text" class="promo-input" id="promoCode" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥">
                            <button type="button" class="apply-promo-btn" id="applyPromoBtn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                        </div>
                        <div class="promo-success" id="promoSuccess" style="display: none;"></div>
                        <div class="promo-error" id="promoError" style="display: none;"></div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">–õ–æ–∫–∞—Ü–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏</label>
                        <button type="button" class="location-btn" id="getLocationBtn">
                            üìç –ü–æ–ª—É—á–∏—Ç—å –º–æ—é –ª–æ–∫–∞—Ü–∏—é
                        </button>
                        <div class="location-status" id="locationStatus">
                            –õ–æ–∫–∞—Ü–∏—è –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞
                        </div>
                        <input type="hidden" id="locationLat">
                        <input type="hidden" id="locationLng">
                    </div>
                    
                    <div class="cart-total">
                        <span>–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</span>
                        <span id="checkoutTotal">0</span> —Å—É–º
                    </div>
                    
                    <div class="modal-buttons">
                        <button type="button" class="modal-btn cancel" id="cancelCheckoutBtn">–û—Ç–º–µ–Ω–∞</button>
                        <button type="submit" class="modal-btn submit" id="submitOrderBtn" disabled>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // ============================
        // Configuration
        // ============================
        const BACKEND_URL = 'https://uzbke-production.up.railway.app';
        const MIN_ORDER_AMOUNT = 50000;
        
        // Telegram WebApp initialization
        const tg = window.Telegram.WebApp;
        
        // Initialize Telegram WebApp
        tg.expand();
        tg.MainButton.hide();
        tg.enableClosingConfirmation();
        
        // ============================
        // State Management
        // ============================
        let foods = [];
        let categories = [];
        let cart = [];
        let currentFilter = 'rating';
        let currentCategory = 'all';
        let userLocation = null;
        let appliedPromo = null;
        
        // ============================
        // DOM Elements
        // ============================
        const loadingEl = document.getElementById('loading');
        const errorStateEl = document.getElementById('errorState');
        const errorMessageEl = document.getElementById('errorMessage');
        const retryBtn = document.getElementById('retryBtn');
        const appContent = document.getElementById('appContent');
        
        const searchInput = document.getElementById('searchInput');
        const filterBtn = document.getElementById('filterBtn');
        const categoryList = document.getElementById('categoryList');
        const foodGrid = document.getElementById('foodGrid');
        const floatingCart = document.getElementById('floatingCart');
        const cartEl = document.getElementById('cart');
        const cartClose = document.getElementById('cartClose');
        const cartItems = document.getElementById('cartItems');
        const cartCount = document.getElementById('cartCount');
        const cartTotal = document.getElementById('cartTotal');
        const checkoutBtn = document.getElementById('checkoutBtn');
        const filterModal = document.getElementById('filterModal');
        const checkoutModal = document.getElementById('checkoutModal');
        const checkoutForm = document.getElementById('checkoutForm');
        const customerName = document.getElementById('customerName');
        const customerPhone = document.getElementById('customerPhone');
        const customerComment = document.getElementById('customerComment');
        const promoCode = document.getElementById('promoCode');
        const applyPromoBtn = document.getElementById('applyPromoBtn');
        const promoSuccess = document.getElementById('promoSuccess');
        const promoError = document.getElementById('promoError');
        const getLocationBtn = document.getElementById('getLocationBtn');
        const locationStatus = document.getElementById('locationStatus');
        const locationLat = document.getElementById('locationLat');
        const locationLng = document.getElementById('locationLng');
        const checkoutTotal = document.getElementById('checkoutTotal');
        const cancelCheckoutBtn = document.getElementById('cancelCheckoutBtn');
        const submitOrderBtn = document.getElementById('submitOrderBtn');
        
        // ============================
        // Utility Functions
        // ============================
        
        function formatPrice(price) {
            return new Intl.NumberFormat('ru-RU').format(Math.round(price));
        }
        
        function showError(message) {
            console.error('Error:', message);
            loadingEl.style.display = 'none';
            errorMessageEl.textContent = message;
            errorStateEl.style.display = 'flex';
            appContent.style.display = 'none';
        }
        
        function hideError() {
            errorStateEl.style.display = 'none';
            appContent.style.display = 'block';
        }
        
        // ============================
        // API Functions
        // ============================
        
        async function fetchData(url, options = {}) {
            try {
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        'Accept': 'application/json',
                        ...options.headers
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('Fetch error:', error);
                throw error;
            }
        }
        
        async function loadCategories() {
            try {
                const initData = tg.initData;
                let url = `${BACKEND_URL}/api/categories`;
                
                if (initData) {
                    url += `?initData=${encodeURIComponent(initData)}`;
                }
                
                const data = await fetchData(url);
                return data;
            } catch (error) {
                console.error('Error loading categories:', error);
                // Return empty array if error
                return [];
            }
        }
        
        async function loadFoods() {
            try {
                const initData = tg.initData;
                let url = `${BACKEND_URL}/api/foods`;
                
                if (initData) {
                    url += `?initData=${encodeURIComponent(initData)}`;
                }
                
                const data = await fetchData(url);
                return data;
            } catch (error) {
                console.error('Error loading foods:', error);
                throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–µ–Ω—é. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
            }
        }
        
        async function validatePromoCode(code) {
            try {
                const initData = tg.initData;
                let url = `${BACKEND_URL}/api/promo/validate?code=${encodeURIComponent(code)}`;
                
                if (initData) {
                    url += `&initData=${encodeURIComponent(initData)}`;
                }
                
                const data = await fetchData(url);
                return data;
            } catch (error) {
                console.error('Error validating promo:', error);
                return { valid: false };
            }
        }
        
        // ============================
        // Data Loading
        // ============================
        
        async function loadAllData() {
            try {
                hideError();
                loadingEl.style.display = 'flex';
                
                // Load categories and foods
                categories = await loadCategories();
                foods = await loadFoods();
                
                console.log('Loaded categories:', categories.length);
                console.log('Loaded foods:', foods.length);
                
                // Set user name from Telegram
                const user = tg.initDataUnsafe.user;
                if (user) {
                    const fullName = `${user.first_name || ''} ${user.last_name || ''}`.trim();
                    customerName.value = fullName || '';
                }
                
                // Render UI
                renderCategories();
                renderFoods();
                updateCart();
                
                // Hide loading, show app
                setTimeout(() => {
                    loadingEl.style.display = 'none';
                    appContent.style.display = 'block';
                    
                    // Show welcome message
                    if (foods.length > 0) {
                        tg.showPopup({
                            title: '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!',
                            message: '–ú–µ–Ω—é —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ. –í—ã–±–µ—Ä–∏—Ç–µ –±–ª—é–¥–∞ –∏ –æ—Ñ–æ—Ä–º–∏—Ç–µ –∑–∞–∫–∞–∑.',
                            buttons: [{ type: 'ok' }]
                        });
                    }
                }, 500);
                
            } catch (error) {
                showError(error.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.');
            }
        }
        
        // ============================
        // UI Rendering
        // ============================
        
        function renderCategories() {
            categoryList.innerHTML = '';
            
            // Add "All" category
            const allBtn = document.createElement('button');
            allBtn.className = `category-btn ${currentCategory === 'all' ? 'active' : ''}`;
            allBtn.textContent = '–í—Å–µ';
            allBtn.onclick = () => {
                currentCategory = 'all';
                document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
                allBtn.classList.add('active');
                renderFoods();
            };
            categoryList.appendChild(allBtn);
            
            // Add food categories
            categories.forEach(category => {
                const btn = document.createElement('button');
                btn.className = `category-btn ${currentCategory === category.id.toString() ? 'active' : ''}`;
                btn.textContent = category.name;
                btn.onclick = () => {
                    currentCategory = category.id.toString();
                    document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
                    btn.classList.add('active');
                    renderFoods();
                };
                categoryList.appendChild(btn);
            });
        }
        
        function renderFoods() {
            foodGrid.innerHTML = '';
            
            let filteredFoods = [...foods];
            
            // Filter by category
            if (currentCategory !== 'all') {
                filteredFoods = filteredFoods.filter(food => food.category_id.toString() === currentCategory);
            }
            
            // Apply search
            const searchTerm = searchInput.value.toLowerCase();
            if (searchTerm) {
                filteredFoods = filteredFoods.filter(food => 
                    food.name.toLowerCase().includes(searchTerm) ||
                    (food.description && food.description.toLowerCase().includes(searchTerm))
                );
            }
            
            // Apply filter
            switch (currentFilter) {
                case 'rating':
                    filteredFoods.sort((a, b) => b.rating - a.rating);
                    break;
                case 'new':
                    filteredFoods.sort((a, b) => (b.is_new ? 1 : 0) - (a.is_new ? 1 : 0));
                    break;
                case 'price_asc':
                    filteredFoods.sort((a, b) => a.price - b.price);
                    break;
                case 'price_desc':
                    filteredFoods.sort((a, b) => b.price - a.price);
                    break;
            }
            
            // Show empty state if no foods
            if (filteredFoods.length === 0) {
                foodGrid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üçΩÔ∏è</div>
                        <div>–ë–ª—é–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
                        ${searchTerm ? '<div>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å</div>' : ''}
                    </div>
                `;
                return;
            }
            
            // Render food cards
            filteredFoods.forEach(food => {
                const cartItem = cart.find(item => item.id === food.id);
                const inCart = cartItem ? cartItem.qty : 0;
                
                const card = document.createElement('div');
                card.className = 'food-card';
                card.innerHTML = `
                    <div class="food-image">
                        <img src="${food.image_url || 'https://via.placeholder.com/300x200/2d2d2d/808080?text=No+Image'}" 
                             alt="${food.name}"
                             onerror="this.src='https://via.placeholder.com/300x200/2d2d2d/808080?text=Image+Error'">
                        ${food.is_new ? '<div class="food-badge">NEW</div>' : ''}
                    </div>
                    <div class="food-info">
                        <div class="food-name">${food.name}</div>
                        <div class="food-desc">${food.description || '–í–∫—É—Å–Ω–æ–µ –±–ª—é–¥–æ'}</div>
                        <div class="food-bottom">
                            <div>
                                <div class="food-price">${formatPrice(food.price)} —Å—É–º</div>
                                <div class="food-rating">‚≠ê ${food.rating?.toFixed(1) || '5.0'}</div>
                            </div>
                            <button class="add-btn ${inCart ? 'added' : ''}" data-id="${food.id}">
                                ${inCart ? `‚úì ${inCart}` : '–î–æ–±–∞–≤–∏—Ç—å'}
                            </button>
                        </div>
                    </div>
                `;
                
                const addBtn = card.querySelector('.add-btn');
                addBtn.onclick = () => addToCart(food);
                
                foodGrid.appendChild(card);
            });
        }
        
        // ============================
        // Cart Management
        // ============================
        
        function addToCart(food) {
            const existingItem = cart.find(item => item.id === food.id);
            
            if (existingItem) {
                existingItem.qty += 1;
            } else {
                cart.push({
                    ...food,
                    qty: 1
                });
            }
            
            updateCart();
            renderFoods();
            showCart();
            
            // Show feedback
            if (tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('light');
            }
        }
        
        function removeFromCart(foodId) {
            const itemIndex = cart.findIndex(item => item.id === foodId);
            if (itemIndex !== -1) {
                if (cart[itemIndex].qty > 1) {
                    cart[itemIndex].qty -= 1;
                } else {
                    cart.splice(itemIndex, 1);
                }
                updateCart();
                renderFoods();
                
                // Show feedback
                if (tg.HapticFeedback) {
                    tg.HapticFeedback.impactOccurred('light');
                }
            }
        }
        
        function updateCart() {
            // Update cart count
            const totalItems = cart.reduce((sum, item) => sum + item.qty, 0);
            cartCount.textContent = totalItems;
            
            // Show/hide floating cart
            floatingCart.style.display = totalItems > 0 ? 'flex' : 'none';
            
            // Update cart items
            cartItems.innerHTML = '';
            let subtotal = 0;
            
            cart.forEach(item => {
                const itemTotal = item.price * item.qty;
                subtotal += itemTotal;
                
                const itemEl = document.createElement('div');
                itemEl.className = 'cart-item';
                itemEl.innerHTML = `
                    <div class="cart-item-info">
                        <div class="cart-item-name">${item.name}</div>
                        <div class="cart-item-price">${formatPrice(item.price)} —Å—É–º √ó ${item.qty}</div>
                    </div>
                    <div class="cart-item-controls">
                        <button class="cart-btn minus" data-id="${item.id}">‚àí</button>
                        <div class="cart-item-qty">${item.qty}</div>
                        <button class="cart-btn plus" data-id="${item.id}">+</button>
                    </div>
                `;
                
                itemEl.querySelector('.minus').onclick = () => removeFromCart(item.id);
                itemEl.querySelector('.plus').onclick = () => addToCart(item);
                
                cartItems.appendChild(itemEl);
            });
            
            // Apply promo discount
            let discount = 0;
            let total = subtotal;
            
            if (appliedPromo) {
                discount = subtotal * (appliedPromo.discount_percent / 100);
                total = subtotal - discount;
                
                // Add discount row
                const discountEl = document.createElement('div');
                discountEl.className = 'cart-item';
                discountEl.innerHTML = `
                    <div class="cart-item-info">
                        <div class="cart-item-name" style="color: var(--success);">–°–∫–∏–¥–∫–∞ (${appliedPromo.discount_percent}%)</div>
                    </div>
                    <div class="cart-item-controls">
                        <div class="cart-item-qty" style="color: var(--success);">-${formatPrice(discount)}</div>
                    </div>
                `;
                cartItems.appendChild(discountEl);
            }
            
            // Update totals
            cartTotal.textContent = formatPrice(total);
            checkoutTotal.textContent = formatPrice(total);
            
            // Enable/disable checkout button
            checkoutBtn.disabled = total < MIN_ORDER_AMOUNT || totalItems === 0;
            checkoutBtn.innerHTML = total < MIN_ORDER_AMOUNT 
                ? `–ú–∏–Ω–∏–º—É–º ${formatPrice(MIN_ORDER_AMOUNT)} —Å—É–º`
                : '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑';
            
            // Update submit button
            submitOrderBtn.disabled = !userLocation;
        }
        
        function showCart() {
            cartEl.classList.add('open');
        }
        
        function hideCart() {
            cartEl.classList.remove('open');
        }
        
        // ============================
        // Location Handling
        // ============================
        
        function getLocation() {
            if (!navigator.geolocation) {
                locationStatus.textContent = '–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º';
                locationStatus.style.color = 'var(--danger)';
                return;
            }
            
            getLocationBtn.disabled = true;
            getLocationBtn.textContent = '–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ...';
            locationStatus.textContent = '–û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ...';
            locationStatus.style.color = 'var(--text-secondary)';
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    locationLat.value = userLocation.lat;
                    locationLng.value = userLocation.lng;
                    
                    locationStatus.textContent = '–õ–æ–∫–∞—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ ‚úì';
                    locationStatus.style.color = 'var(--success)';
                    getLocationBtn.textContent = 'üìç –õ–æ–∫–∞—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞';
                    getLocationBtn.style.background = 'var(--success)';
                    
                    submitOrderBtn.disabled = false;
                    
                    // Show feedback
                    if (tg.HapticFeedback) {
                        tg.HapticFeedback.notificationOccurred('success');
                    }
                },
                (error) => {
                    console.error('Geolocation error:', error);
                    
                    let errorMessage = '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ª–æ–∫–∞—Ü–∏—é';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = '–î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–µ—â–µ–Ω';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞';
                            break;
                        case error.TIMEOUT:
                            errorMessage = '–í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ';
                            break;
                    }
                    
                    locationStatus.textContent = errorMessage;
                    locationStatus.style.color = 'var(--danger)';
                    getLocationBtn.textContent = 'üìç –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É';
                    getLocationBtn.disabled = false;
                    
                    // Show feedback
                    if (tg.HapticFeedback) {
                        tg.HapticFeedback.notificationOccurred('error');
                    }
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }
        
        // ============================
        // Promo Code Handling
        // ============================
        
        async function applyPromo() {
            const code = promoCode.value.trim();
            if (!code) {
                promoError.textContent = '–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥';
                promoError.style.display = 'block';
                promoSuccess.style.display = 'none';
                return;
            }
            
            const result = await validatePromoCode(code);
            if (result.valid) {
                appliedPromo = result;
                promoSuccess.textContent = `–ü—Ä–æ–º–æ–∫–æ–¥ "${code}" –ø—Ä–∏–º–µ–Ω–µ–Ω! –°–∫–∏–¥–∫–∞ ${result.discount_percent}%`;
                promoSuccess.style.display = 'block';
                promoError.style.display = 'none';
                updateCart();
                
                // Show feedback
                if (tg.HapticFeedback) {
                    tg.HapticFeedback.notificationOccurred('success');
                }
            } else {
                promoError.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π –∏–ª–∏ –∏—Å—Ç–µ–∫—à–∏–π –ø—Ä–æ–º–æ–∫–æ–¥';
                promoError.style.display = 'block';
                promoSuccess.style.display = 'none';
                
                // Show feedback
                if (tg.HapticFeedback) {
                    tg.HapticFeedback.notificationOccurred('error');
                }
            }
        }
        
        // ============================
        // Order Submission
        // ============================
        
        function submitOrder() {
            // Validate form
            if (!customerName.value.trim()) {
                tg.showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è');
                return;
            }
            
            if (!customerPhone.value.trim() || customerPhone.value.length < 12) {
                tg.showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞');
                return;
            }
            
            if (!userLocation) {
                tg.showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –≤–∞—à—É –ª–æ–∫–∞—Ü–∏—é');
                return;
            }
            
            // Prepare order data
            const orderData = {
                type: "order_create",
                items: cart.map(item => ({
                    food_id: item.id,
                    name: item.name,
                    qty: item.qty,
                    price: item.price
                })),
                total: parseFloat(cartTotal.textContent.replace(/\s/g, '')),
                customer_name: customerName.value.trim(),
                phone: customerPhone.value.trim(),
                comment: customerComment.value.trim(),
                location: userLocation,
                created_at_client: new Date().toISOString()
            };
            
            console.log('Sending order data:', orderData);
            
            // Send data to Telegram bot
            tg.sendData(JSON.stringify(orderData));
            
            // Show confirmation
            tg.showAlert('‚úÖ –ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω! –û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.');
            
            // Clear cart and close modals
            cart = [];
            updateCart();
            checkoutModal.classList.remove('open');
            
            // Close WebApp after delay
            setTimeout(() => {
                tg.close();
            }, 2000);
        }
        
        // ============================
        // Event Listeners
        // ============================
        
        searchInput.addEventListener('input', renderFoods);
        
        filterBtn.addEventListener('click', () => {
            filterModal.classList.add('open');
        });
        
        filterModal.addEventListener('click', (e) => {
            if (e.target === filterModal) {
                filterModal.classList.remove('open');
            }
            
            if (e.target.classList.contains('filter-option')) {
                currentFilter = e.target.dataset.filter;
                document.querySelectorAll('.filter-option').forEach(opt => opt.classList.remove('active'));
                e.target.classList.add('active');
                renderFoods();
                filterModal.classList.remove('open');
                
                // Show feedback
                if (tg.HapticFeedback) {
                    tg.HapticFeedback.selectionChanged();
                }
            }
        });
        
        floatingCart.addEventListener('click', showCart);
        
        cartClose.addEventListener('click', hideCart);
        
        checkoutBtn.addEventListener('click', () => {
            hideCart();
            checkoutModal.classList.add('open');
        });
        
        checkoutModal.addEventListener('click', (e) => {
            if (e.target === checkoutModal) {
                checkoutModal.classList.remove('open');
            }
        });
        
        cancelCheckoutBtn.addEventListener('click', () => {
            checkoutModal.classList.remove('open');
        });
        
        getLocationBtn.addEventListener('click', getLocation);
        
        applyPromoBtn.addEventListener('click', applyPromo);
        
        // Enter key for promo code
        promoCode.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                applyPromo();
            }
        });
        
        checkoutForm.addEventListener('submit', (e) => {
            e.preventDefault();
            submitOrder();
        });
        
        // Phone input mask
        customerPhone.addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '');
            
            if (value.startsWith('998')) {
                value = '+998 ' + value.slice(3);
            } else if (value.startsWith('8')) {
                value = '+7 ' + value.slice(1);
            } else if (value.startsWith('7')) {
                value = '+7 ' + value.slice(1);
            } else if (value) {
                value = '+998 ' + value;
            }
            
            // Format as +998 XX XXX XX XX
            if (value.length > 4) {
                value = value.slice(0, 4) + ' ' + value.slice(4);
            }
            if (value.length > 8) {
                value = value.slice(0, 8) + ' ' + value.slice(8);
            }
            if (value.length > 12) {
                value = value.slice(0, 12) + ' ' + value.slice(12);
            }
            if (value.length > 15) {
                value = value.slice(0, 15);
            }
            
            e.target.value = value;
        });
        
        retryBtn.addEventListener('click', loadAllData);
        
        // ============================
        // Initialize App
        // ============================
        
        document.addEventListener('DOMContentLoaded', () => {
            // Check if running in Telegram WebApp
            if (!window.Telegram?.WebApp) {
                showError('–≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ Telegram. –û—Ç–∫—Ä–æ–π—Ç–µ –µ–≥–æ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞.');
                return;
            }
            
            console.log('Telegram WebApp initialized:', tg.initDataUnsafe);
            
            // Load data
            loadAllData();
        });
        
        // Handle back button in Telegram
        if (tg.BackButton) {
            tg.BackButton.onClick(() => {
                if (checkoutModal.classList.contains('open')) {
                    checkoutModal.classList.remove('open');
                } else if (cartEl.classList.contains('open')) {
                    hideCart();
                } else if (filterModal.classList.contains('open')) {
                    filterModal.classList.remove('open');
                }
            });
            
            // Show/hide back button based on modal state
            const observer = new MutationObserver((mutations) => {
                const hasModalOpen = checkoutModal.classList.contains('open') || 
                                    cartEl.classList.contains('open') || 
                                    filterModal.classList.contains('open');
                
                if (hasModalOpen) {
                    tg.BackButton.show();
                } else {
                    tg.BackButton.hide();
                }
            });
            
            observer.observe(checkoutModal, { attributes: true, attributeFilter: ['class'] });
            observer.observe(cartEl, { attributes: true, attributeFilter: ['class'] });
            observer.observe(filterModal, { attributes: true, attributeFilter: ['class'] });
        }
    </script>
</body>
</html>
