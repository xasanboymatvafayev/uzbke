<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>FIESTA - –î–æ—Å—Ç–∞–≤–∫–∞ –µ–¥—ã</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-card: #242424;
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --accent: #ff6b35;
            --accent-hover: #ff5722;
            --border: #3d3d3d;
            --success: #4caf50;
            --star: #ffc107;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            padding-bottom: 80px;
            overflow-x: hidden;
        }

        /* Header */
        .header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--bg-secondary);
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
            color: var(--accent);
        }

        .search-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 16px;
        }

        .search-input::placeholder {
            color: var(--text-secondary);
        }

        .settings-icon {
            position: absolute;
            right: 15px;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        /* Categories */
        .categories {
            display: flex;
            overflow-x: auto;
            padding: 15px 20px;
            gap: 10px;
            scrollbar-width: none;
        }

        .categories::-webkit-scrollbar {
            display: none;
        }

        .category-btn {
            padding: 10px 20px;
            border: 1px solid var(--border);
            border-radius: 20px;
            background: var(--bg-card);
            color: var(--text-primary);
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.3s;
        }

        .category-btn.active {
            background: var(--accent);
            border-color: var(--accent);
        }

        /* Products Grid */
        .products-grid {
            padding: 0 20px 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px;
        }

        .product-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 12px;
            border: 1px solid var(--border);
            transition: transform 0.2s;
        }

        .product-card:active {
            transform: scale(0.98);
        }

        .product-image {
            width: 100%;
            height: 120px;
            background: var(--bg-secondary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            margin-bottom: 10px;
        }

        .product-name {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 5px;
            line-height: 1.3;
            height: 40px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .product-desc {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            height: 32px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .product-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }

        .product-price {
            font-size: 16px;
            font-weight: bold;
            color: var(--accent);
        }

        .product-rating {
            display: flex;
            align-items: center;
            gap: 3px;
            font-size: 13px;
            color: var(--star);
        }

        .add-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: background 0.3s;
        }

        .add-btn:active {
            background: var(--accent-hover);
        }

        /* Cart Float */
        .cart-float {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: var(--accent);
            padding: 15px 20px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            cursor: pointer;
            z-index: 1000;
            transition: transform 0.3s;
        }

        .cart-float.hidden {
            transform: translateY(150px);
        }

        .cart-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .cart-count {
            background: white;
            color: var(--accent);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .cart-total {
            font-size: 18px;
            font-weight: bold;
            color: white;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            overflow-y: auto;
        }

        .modal.active {
            display: block;
        }

        .modal-content {
            background: var(--bg-secondary);
            margin: 20px;
            padding: 25px;
            border-radius: 16px;
            max-width: 500px;
            margin: 50px auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            font-size: 22px;
        }

        .close-btn {
            font-size: 28px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .filter-option {
            padding: 15px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-option:hover {
            border-color: var(--accent);
        }

        /* Cart Items */
        .cart-items {
            margin-bottom: 20px;
        }

        .cart-item {
            background: var(--bg-card);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .cart-item-price {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .qty-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .qty-value {
            min-width: 30px;
            text-align: center;
            font-weight: 600;
        }

        /* Form */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 16px;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        textarea.form-input {
            resize: vertical;
            min-height: 80px;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:disabled {
            background: var(--border);
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .location-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 15px;
        }

        .location-status {
            margin-top: 10px;
            padding: 10px;
            background: var(--success);
            color: white;
            border-radius: 8px;
            text-align: center;
            font-size: 14px;
        }

        .error-msg {
            color: #f44336;
            font-size: 14px;
            margin-top: 5px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: var(--text-secondary);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        .promo-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .promo-input-group input {
            flex: 1;
        }

        .promo-success {
            background: var(--success);
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }

        .order-summary {
            background: var(--bg-card);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 15px;
        }

        .summary-row.total {
            font-size: 18px;
            font-weight: bold;
            padding-top: 10px;
            border-top: 1px solid var(--border);
        }

        .discount-row {
            color: var(--success);
        }

        /* Badge */
        .new-badge {
            background: var(--success);
            color: white;
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 4px;
            position: absolute;
            top: 8px;
            right: 8px;
            font-weight: 600;
        }

        .product-card {
            position: relative;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéâ FIESTA</h1>
        <div class="search-container">
            <input type="text" class="search-input" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –±–ª—é–¥...">
            <span class="settings-icon" id="settingsIcon">‚öôÔ∏è</span>
        </div>
    </div>

    <div class="categories" id="categories">
        <button class="category-btn active" data-category="all">–í—Å–µ</button>
    </div>

    <div id="productsContainer" class="products-grid">
        <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <div class="cart-float hidden" id="cartFloat">
        <div class="cart-info">
            <div class="cart-count" id="cartCount">0</div>
            <span>–ö–æ—Ä–∑–∏–Ω–∞</span>
        </div>
        <div class="cart-total" id="cartTotal">0 —Å—É–º</div>
    </div>

    <!-- Filter Modal -->
    <div class="modal" id="filterModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–§–∏–ª—å—Ç—Ä</h2>
                <span class="close-btn" onclick="closeFilterModal()">&times;</span>
            </div>
            <div class="filter-option" onclick="applyFilter('rating')">
                üìä –ü–æ —Ä–µ–π—Ç–∏–Ω–≥—É
            </div>
            <div class="filter-option" onclick="applyFilter('new')">
                ‚ú® –ù–æ–≤—ã–µ –±–ª—é–¥–∞
            </div>
            <div class="filter-option" onclick="applyFilter('price_asc')">
                üí∞ –î–µ—à–µ–≤–ª–µ
            </div>
            <div class="filter-option" onclick="applyFilter('price_desc')">
                üíé –î–æ—Ä–æ–∂–µ
            </div>
        </div>
    </div>

    <!-- Cart Modal -->
    <div class="modal" id="cartModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–ö–æ—Ä–∑–∏–Ω–∞</h2>
                <span class="close-btn" onclick="closeCartModal()">&times;</span>
            </div>
            <div class="cart-items" id="cartItems"></div>
            <div class="order-summary">
                <div class="summary-row">
                    <span>–°—É–º–º–∞:</span>
                    <span id="summarySubtotal">0 —Å—É–º</span>
                </div>
                <div class="summary-row discount-row" id="discountRow" style="display: none;">
                    <span>–°–∫–∏–¥–∫–∞:</span>
                    <span id="summaryDiscount">0 —Å—É–º</span>
                </div>
                <div class="summary-row total">
                    <span>–ò—Ç–æ–≥–æ:</span>
                    <span id="summaryTotal">0 —Å—É–º</span>
                </div>
            </div>
            <button class="btn btn-primary" id="checkoutBtn" disabled onclick="showCheckout()">
                –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑
            </button>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div class="modal" id="checkoutModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h2>
                <span class="close-btn" onclick="closeCheckoutModal()">&times;</span>
            </div>

            <div class="promo-input-group">
                <input type="text" class="form-input" id="promoInput" placeholder="–ü—Ä–æ–º–æ–∫–æ–¥">
                <button class="btn btn-secondary" onclick="applyPromo()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            </div>
            <div class="promo-success" id="promoSuccess" style="display: none;"></div>

            <form id="checkoutForm">
                <div class="form-group">
                    <label>–ò–º—è *</label>
                    <input type="text" class="form-input" id="customerName" required>
                </div>

                <div class="form-group">
                    <label>–¢–µ–ª–µ—Ñ–æ–Ω *</label>
                    <input type="tel" class="form-input" id="customerPhone" placeholder="+998 XX XXX XX XX" required>
                </div>

                <div class="form-group">
                    <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                    <textarea class="form-input" id="customerComment" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è..."></textarea>
                </div>

                <div class="form-group">
                    <label>–õ–æ–∫–∞—Ü–∏—è *</label>
                    <button type="button" class="btn btn-secondary location-btn" onclick="getLocation()">
                        üìç –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ª–æ–∫–∞—Ü–∏—é
                    </button>
                    <div class="location-status" id="locationStatus" style="display: none;">
                        ‚úÖ –õ–æ–∫–∞—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞
                    </div>
                    <div class="error-msg" id="locationError"></div>
                </div>

                <button type="submit" class="btn btn-primary" id="submitOrderBtn" disabled>
                    –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑
                </button>
            </form>
        </div>
    </div>

    <script>
        // Telegram WebApp
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.MainButton.hide();

        // State
        let categories = [];
        let foods = [];
        let filteredFoods = [];
        let cart = [];
        let currentCategory = 'all';
        let currentFilter = null;
        let userLocation = null;
        let appliedPromo = null;

        const BACKEND_URL = 'https://uzbke-production.up.railway.app';
        const MIN_ORDER = 50000;

        // Initialize
        async function init() {
            try {
                // Load categories
                const categoriesRes = await fetch(`${BACKEND_URL}/api/categories`);
                categories = await categoriesRes.json();
                renderCategories();

                // Load foods
                const foodsRes = await fetch(`${BACKEND_URL}/api/foods`);
                foods = await foodsRes.json();
                filteredFoods = foods;
                renderProducts();

                // Set default name from Telegram
                if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                    document.getElementById('customerName').value = 
                        tg.initDataUnsafe.user.first_name + ' ' + (tg.initDataUnsafe.user.last_name || '');
                }
            } catch (error) {
                console.error('Init error:', error);
                document.getElementById('productsContainer').innerHTML = 
                    '<div class="empty-state"><div class="empty-state-icon">‚ùå</div><p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p></div>';
            }
        }

        // Render categories
        function renderCategories() {
            const container = document.getElementById('categories');
            container.innerHTML = '<button class="category-btn active" data-category="all" onclick="selectCategory(\'all\')">–í—Å–µ</button>';
            
            categories.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.dataset.category = cat.id;
                btn.textContent = cat.name;
                btn.onclick = () => selectCategory(cat.id);
                container.appendChild(btn);
            });
        }

        // Select category
        function selectCategory(categoryId) {
            currentCategory = categoryId;
            
            // Update active button
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.category == categoryId) {
                    btn.classList.add('active');
                }
            });

            filterProducts();
        }

        // Filter products
        function filterProducts() {
            filteredFoods = foods;

            // Filter by category
            if (currentCategory !== 'all') {
                filteredFoods = filteredFoods.filter(f => f.category_id == currentCategory);
            }

            // Filter by search
            const searchQuery = document.getElementById('searchInput').value.toLowerCase();
            if (searchQuery) {
                filteredFoods = filteredFoods.filter(f => 
                    f.name.toLowerCase().includes(searchQuery) ||
                    (f.description && f.description.toLowerCase().includes(searchQuery))
                );
            }

            // Apply sorting
            if (currentFilter === 'rating') {
                filteredFoods.sort((a, b) => b.rating - a.rating);
            } else if (currentFilter === 'new') {
                filteredFoods.sort((a, b) => b.is_new - a.is_new);
            } else if (currentFilter === 'price_asc') {
                filteredFoods.sort((a, b) => a.price - b.price);
            } else if (currentFilter === 'price_desc') {
                filteredFoods.sort((a, b) => b.price - a.price);
            }

            renderProducts();
        }

        // Render products
        function renderProducts() {
            const container = document.getElementById('productsContainer');
            
            if (filteredFoods.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üçΩÔ∏è</div><p>–ë–ª—é–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p></div>';
                return;
            }

            container.innerHTML = filteredFoods.map(food => `
                <div class="product-card">
                    ${food.is_new ? '<div class="new-badge">NEW</div>' : ''}
                    <div class="product-image">${getEmoji(food.category_id)}</div>
                    <div class="product-name">${food.name}</div>
                    <div class="product-desc">${food.description || ''}</div>
                    <div class="product-rating">‚≠ê ${food.rating.toFixed(1)}</div>
                    <div class="product-footer">
                        <div class="product-price">${formatPrice(food.price)}</div>
                        <button class="add-btn" onclick="addToCart(${food.id})">+</button>
                    </div>
                </div>
            `).join('');
        }

        // Get emoji for category
        function getEmoji(categoryId) {
            const cat = categories.find(c => c.id === categoryId);
            if (!cat) return 'üçΩÔ∏è';
            
            const emojis = {
                'Lavash': 'üåØ',
                'Burger': 'üçî',
                'Xaggi': 'ü•ô',
                'Shaurma': 'üåÆ',
                'Hotdog': 'üå≠',
                'Combo': 'üç±',
                'Sneki': 'üçü',
                'Sous': 'üßÇ',
                'Napitki': 'ü•§'
            };
            
            return emojis[cat.name] || 'üçΩÔ∏è';
        }

        // Format price
        function formatPrice(price) {
            return new Intl.NumberFormat('ru-RU').format(price) + ' —Å—É–º';
        }

        // Add to cart
        function addToCart(foodId) {
            const food = foods.find(f => f.id === foodId);
            if (!food) return;

            const cartItem = cart.find(item => item.food_id === foodId);
            if (cartItem) {
                cartItem.qty++;
            } else {
                cart.push({
                    food_id: foodId,
                    name: food.name,
                    price: food.price,
                    qty: 1
                });
            }

            updateCart();
            
            // Haptic feedback
            if (tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('light');
            }
        }

        // Update cart
        function updateCart() {
            const total = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            const count = cart.reduce((sum, item) => sum + item.qty, 0);

            document.getElementById('cartCount').textContent = count;
            document.getElementById('cartTotal').textContent = formatPrice(total);

            const cartFloat = document.getElementById('cartFloat');
            if (count > 0) {
                cartFloat.classList.remove('hidden');
            } else {
                cartFloat.classList.add('hidden');
            }

            updateCheckoutButton();
        }

        // Update checkout button
        function updateCheckoutButton() {
            const total = getTotal();
            const btn = document.getElementById('checkoutBtn');
            
            if (total >= MIN_ORDER) {
                btn.disabled = false;
                btn.textContent = '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑';
            } else {
                btn.disabled = true;
                btn.textContent = `–ú–∏–Ω–∏–º—É–º ${formatPrice(MIN_ORDER)}`;
            }
        }

        // Get subtotal
        function getSubtotal() {
            return cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
        }

        // Get discount amount
        function getDiscount() {
            if (!appliedPromo) return 0;
            return getSubtotal() * (appliedPromo.discount_percent / 100);
        }

        // Get total
        function getTotal() {
            return getSubtotal() - getDiscount();
        }

        // Show cart modal
        document.getElementById('cartFloat').onclick = function() {
            if (cart.length === 0) return;

            const container = document.getElementById('cartItems');
            container.innerHTML = cart.map(item => `
                <div class="cart-item">
                    <div class="cart-item-info">
                        <div class="cart-item-name">${item.name}</div>
                        <div class="cart-item-price">${formatPrice(item.price * item.qty)}</div>
                    </div>
                    <div class="cart-item-controls">
                        <button class="qty-btn" onclick="changeQty(${item.food_id}, -1)">‚àí</button>
                        <div class="qty-value">${item.qty}</div>
                        <button class="qty-btn" onclick="changeQty(${item.food_id}, 1)">+</button>
                    </div>
                </div>
            `).join('');

            const subtotal = getSubtotal();
            const discount = getDiscount();
            const total = getTotal();

            document.getElementById('summarySubtotal').textContent = formatPrice(subtotal);
            
            if (discount > 0) {
                document.getElementById('discountRow').style.display = 'flex';
                document.getElementById('summaryDiscount').textContent = '-' + formatPrice(discount);
            } else {
                document.getElementById('discountRow').style.display = 'none';
            }
            
            document.getElementById('summaryTotal').textContent = formatPrice(total);

            updateCheckoutButton();

            document.getElementById('cartModal').classList.add('active');
        };

        // Change quantity
        function changeQty(foodId, delta) {
            const item = cart.find(i => i.food_id === foodId);
            if (!item) return;

            item.qty += delta;

            if (item.qty <= 0) {
                cart = cart.filter(i => i.food_id !== foodId);
            }

            updateCart();
            
            // Re-render cart modal if open
            if (document.getElementById('cartModal').classList.contains('active')) {
                document.getElementById('cartFloat').click();
            }
        }

        // Close cart modal
        function closeCartModal() {
            document.getElementById('cartModal').classList.remove('active');
        }

        // Show checkout
        function showCheckout() {
            closeCartModal();
            document.getElementById('checkoutModal').classList.add('active');
        }

        // Close checkout modal
        function closeCheckoutModal() {
            document.getElementById('checkoutModal').classList.remove('active');
        }

        // Apply promo
        async function applyPromo() {
            const code = document.getElementById('promoInput').value.trim().toUpperCase();
            if (!code) return;

            try {
                const response = await fetch(`${BACKEND_URL}/api/promo/validate?code=${code}`);
                
                if (response.ok) {
                    const data = await response.json();
                    appliedPromo = data;
                    
                    document.getElementById('promoSuccess').textContent = 
                        `‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω! –°–∫–∏–¥–∫–∞ ${data.discount_percent}%`;
                    document.getElementById('promoSuccess').style.display = 'block';
                    document.getElementById('promoInput').disabled = true;
                    
                    // Update totals in cart modal if open
                    const subtotal = getSubtotal();
                    const discount = getDiscount();
                    const total = getTotal();
                    
                    if (document.getElementById('cartModal').classList.contains('active')) {
                        document.getElementById('summarySubtotal').textContent = formatPrice(subtotal);
                        document.getElementById('discountRow').style.display = 'flex';
                        document.getElementById('summaryDiscount').textContent = '-' + formatPrice(discount);
                        document.getElementById('summaryTotal').textContent = formatPrice(total);
                    }
                    
                    if (tg.HapticFeedback) {
                        tg.HapticFeedback.notificationOccurred('success');
                    }
                } else {
                    alert('‚ùå –ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω');
                }
            } catch (error) {
                console.error('Promo error:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞');
            }
        }

        // Get location
        function getLocation() {
            if (!navigator.geolocation) {
                document.getElementById('locationError').textContent = 
                    '‚ùå –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è';
                return;
            }

            document.getElementById('locationError').textContent = '–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ª–æ–∫–∞—Ü–∏–∏...';

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    document.getElementById('locationStatus').style.display = 'block';
                    document.getElementById('locationError').textContent = '';
                    updateSubmitButton();

                    if (tg.HapticFeedback) {
                        tg.HapticFeedback.notificationOccurred('success');
                    }
                },
                (error) => {
                    document.getElementById('locationError').textContent = 
                        '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ª–æ–∫–∞—Ü–∏—é. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø.';
                    console.error('Geolocation error:', error);
                }
            );
        }

        // Update submit button
        function updateSubmitButton() {
            const btn = document.getElementById('submitOrderBtn');
            const name = document.getElementById('customerName').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();

            btn.disabled = !(name && phone && userLocation);
        }

        // Form inputs validation
        document.getElementById('customerName').oninput = updateSubmitButton;
        document.getElementById('customerPhone').oninput = updateSubmitButton;

        // Phone mask
        document.getElementById('customerPhone').oninput = function(e) {
            let value = e.target.value.replace(/\D/g, '');
            
            if (value.length > 0 && !value.startsWith('998')) {
                value = '998' + value;
            }
            
            if (value.length > 12) {
                value = value.slice(0, 12);
            }
            
            let formatted = '+';
            if (value.length > 0) formatted += value.slice(0, 3);
            if (value.length > 3) formatted += ' ' + value.slice(3, 5);
            if (value.length > 5) formatted += ' ' + value.slice(5, 8);
            if (value.length > 8) formatted += ' ' + value.slice(8, 10);
            if (value.length > 10) formatted += ' ' + value.slice(10, 12);
            
            e.target.value = formatted;
            updateSubmitButton();
        };

        // Submit order
        document.getElementById('checkoutForm').onsubmit = async function(e) {
            e.preventDefault();

            const name = document.getElementById('customerName').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();
            const comment = document.getElementById('customerComment').value.trim();

            if (!userLocation) {
                alert('‚ùå –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ª–æ–∫–∞—Ü–∏—é');
                return;
            }

            const total = getTotal();
            if (total < MIN_ORDER) {
                alert(`‚ùå –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞ ${formatPrice(MIN_ORDER)}`);
                return;
            }

            // Prepare order data
            const orderData = {
                type: 'order_create',
                items: cart,
                total: total,
                customer_name: name,
                phone: phone,
                comment: comment,
                location: userLocation,
                promo_code: appliedPromo ? appliedPromo.code : null,
                created_at_client: new Date().toISOString()
            };

            // Send to bot
            tg.sendData(JSON.stringify(orderData));
            
            // Close WebApp
            setTimeout(() => {
                tg.close();
            }, 100);
        };

        // Search
        document.getElementById('searchInput').oninput = function() {
            filterProducts();
        };

        // Settings icon - open filter
        document.getElementById('settingsIcon').onclick = function() {
            document.getElementById('filterModal').classList.add('active');
        };

        // Close filter modal
        function closeFilterModal() {
            document.getElementById('filterModal').classList.remove('active');
        }

        // Apply filter
        function applyFilter(filterType) {
            currentFilter = filterType;
            filterProducts();
            closeFilterModal();
        }

        // Close modals on background click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.onclick = function(e) {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            };
        });

        // Initialize on load
        init();

        // Prevent zoom on double tap
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    </script>
</body>
</html>
