<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FIESTA - Food Delivery</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2a2a2a;
            --bg-card: #333333;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --accent: #ff6b35;
            --accent-hover: #ff8555;
            --success: #4caf50;
            --border: #444444;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
            padding-bottom: 100px;
        }

        /* Header */
        .header {
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
            padding: 15px;
            z-index: 100;
            border-bottom: 1px solid var(--border);
        }

        .search-container {
            position: relative;
            margin-bottom: 10px;
        }

        .search-input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 16px;
        }

        .search-input::placeholder {
            color: var(--text-secondary);
        }

        .settings-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 20px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        /* Categories */
        .categories {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 10px 0;
            scrollbar-width: none;
        }

        .categories::-webkit-scrollbar {
            display: none;
        }

        .category-btn {
            padding: 8px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text-secondary);
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s;
            font-size: 14px;
        }

        .category-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        /* Food Grid */
        .foods-container {
            padding: 15px;
        }

        .foods-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px;
        }

        .food-card {
            background: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s;
            border: 1px solid var(--border);
        }

        .food-card:active {
            transform: scale(0.98);
        }

        .food-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            position: relative;
        }

        .new-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--accent);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
        }

        .food-info {
            padding: 12px;
        }

        .food-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .food-desc {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .food-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .food-price {
            font-weight: bold;
            color: var(--accent);
            font-size: 16px;
        }

        .food-rating {
            display: flex;
            align-items: center;
            gap: 3px;
            font-size: 12px;
        }

        .add-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .add-btn:hover {
            background: var(--accent-hover);
        }

        /* Cart */
        .cart-float {
            position: fixed;
            bottom: 20px;
            left: 15px;
            right: 15px;
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 -4px 20px var(--shadow);
            z-index: 200;
            border: 1px solid var(--border);
        }

        .cart-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .cart-info {
            display: flex;
            gap: 15px;
        }

        .cart-count {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .cart-total {
            font-size: 18px;
            font-weight: bold;
            color: var(--accent);
        }

        .checkout-btn {
            width: 100%;
            background: var(--accent);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .checkout-btn:disabled {
            background: var(--border);
            cursor: not-allowed;
        }

        .checkout-btn:not(:disabled):hover {
            background: var(--accent-hover);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 300;
            align-items: flex-end;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            width: 100%;
            max-height: 90vh;
            border-radius: 20px 20px 0 0;
            padding: 20px;
            overflow-y: auto;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: bold;
        }

        .close-btn {
            font-size: 28px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        /* Form */
        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 16px;
        }

        .form-input::placeholder {
            color: var(--text-secondary);
        }

        .geo-btn {
            width: 100%;
            background: var(--success);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .geo-status {
            margin-top: 8px;
            font-size: 12px;
            color: var(--success);
        }

        .submit-btn {
            width: 100%;
            background: var(--accent);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
        }

        /* Filter Modal */
        .filter-option {
            padding: 15px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-option:hover {
            background: var(--accent);
            border-color: var(--accent);
        }

        /* Cart Items */
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--bg-card);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .cart-item-price {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .qty-btn {
            background: var(--accent);
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .qty-display {
            font-weight: bold;
            min-width: 30px;
            text-align: center;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 15px;
        }

        .promo-input {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .promo-input input {
            flex: 1;
        }

        .promo-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            white-space: nowrap;
        }

        .promo-success {
            color: var(--success);
            font-size: 12px;
            margin-top: 5px;
        }

        .promo-error {
            color: #f44336;
            font-size: 12px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="search-container">
            <input type="text" class="search-input" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –±–ª—é–¥...">
            <span class="settings-icon" id="settingsBtn">‚öôÔ∏è</span>
        </div>
        <div class="categories" id="categoriesContainer">
            <button class="category-btn active" data-category="all">–í—Å–µ</button>
        </div>
    </div>

    <!-- Foods Grid -->
    <div class="foods-container">
        <div id="loadingState" class="loading">
            <div>‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
        <div id="emptyState" class="empty-state" style="display: none;">
            <div class="empty-state-icon">üçΩÔ∏è</div>
            <div>–ë–ª—é–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
        </div>
        <div class="foods-grid" id="foodsGrid"></div>
    </div>

    <!-- Cart Float -->
    <div class="cart-float" id="cartFloat" style="display: none;">
        <div class="cart-summary">
            <div class="cart-info">
                <div class="cart-count" id="cartCount">0 —Ç–æ–≤–∞—Ä–æ–≤</div>
                <div class="cart-total" id="cartTotal">0 —Å—É–º</div>
            </div>
        </div>
        <button class="checkout-btn" id="checkoutBtn" disabled>–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
    </div>

    <!-- Filter Modal -->
    <div class="modal" id="filterModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</div>
                <span class="close-btn" onclick="closeFilterModal()">&times;</span>
            </div>
            <div class="filter-option" onclick="applySorting('rating')">‚≠ê –ü–æ —Ä–µ–π—Ç–∏–Ω–≥—É</div>
            <div class="filter-option" onclick="applySorting('new')">üÜï –ù–æ–≤—ã–µ –±–ª—é–¥–∞</div>
            <div class="filter-option" onclick="applySorting('price_asc')">üí∞ –°–Ω–∞—á–∞–ª–∞ –¥–µ—à–µ–≤—ã–µ</div>
            <div class="filter-option" onclick="applySorting('price_desc')">üíé –°–Ω–∞—á–∞–ª–∞ –¥–æ—Ä–æ–≥–∏–µ</div>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div class="modal" id="checkoutModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</div>
                <span class="close-btn" onclick="closeCheckoutModal()">&times;</span>
            </div>

            <!-- Cart Items -->
            <div id="checkoutItems"></div>

            <!-- Promo Code -->
            <div class="form-group">
                <label class="form-label">–ü—Ä–æ–º–æ–∫–æ–¥ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                <div class="promo-input">
                    <input type="text" class="form-input" id="promoInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥">
                    <button class="promo-btn" onclick="validatePromo()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                </div>
                <div id="promoStatus"></div>
            </div>

            <form id="checkoutForm">
                <div class="form-group">
                    <label class="form-label">–ò–º—è</label>
                    <input type="text" class="form-input" id="customerName" required>
                </div>

                <div class="form-group">
                    <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                    <input type="tel" class="form-input" id="customerPhone" placeholder="+998 90 123 45 67" required>
                </div>

                <div class="form-group">
                    <label class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                    <input type="text" class="form-input" id="customerComment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É">
                </div>

                <div class="form-group">
                    <label class="form-label">–õ–æ–∫–∞—Ü–∏—è *</label>
                    <button type="button" class="geo-btn" onclick="getLocation()">
                        üìç –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–æ—é –ª–æ–∫–∞—Ü–∏—é
                    </button>
                    <div id="geoStatus"></div>
                </div>

                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span>–ò—Ç–æ–≥–æ:</span>
                        <span id="checkoutTotal" style="font-weight: bold; color: var(--accent);">0 —Å—É–º</span>
                    </div>
                </div>

                <button type="submit" class="submit-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</button>
            </form>
        </div>
    </div>

    <script>
        // Telegram WebApp Init
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();

        // API Configuration
        const API_URL = 'https://uzbke-production.up.railway.app/api';

        // State
        let categories = [];
        let foods = [];
        let filteredFoods = [];
        let cart = [];
        let currentCategory = 'all';
        let currentSorting = null;
        let userLocation = null;
        let appliedPromo = null;

        // Initialize
        async function init() {
            try {
                // Load categories
                const categoriesRes = await fetch(`${API_URL}/categories`);
                categories = await categoriesRes.json();
                renderCategories();

                // Load foods
                const foodsRes = await fetch(`${API_URL}/foods`);
                foods = await foodsRes.json();
                filteredFoods = [...foods];
                renderFoods();

                // Set default name from Telegram
                if (tg.initDataUnsafe.user) {
                    document.getElementById('customerName').value = tg.initDataUnsafe.user.first_name || '';
                }

                document.getElementById('loadingState').style.display = 'none';
            } catch (error) {
                console.error('Init error:', error);
                document.getElementById('loadingState').innerHTML = '<div>‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
            }
        }

        // Render Categories
        function renderCategories() {
            const container = document.getElementById('categoriesContainer');
            container.innerHTML = '<button class="category-btn active" data-category="all" onclick="filterByCategory(\'all\')">–í—Å–µ</button>';
            
            categories.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.textContent = cat.name;
                btn.dataset.category = cat.id;
                btn.onclick = () => filterByCategory(cat.id);
                container.appendChild(btn);
            });
        }

        // Render Foods
        function renderFoods() {
            const grid = document.getElementById('foodsGrid');
            const emptyState = document.getElementById('emptyState');
            
            if (filteredFoods.length === 0) {
                grid.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            grid.innerHTML = '';

            filteredFoods.forEach(food => {
                const card = document.createElement('div');
                card.className = 'food-card';
                card.onclick = () => addToCart(food);

                const emoji = ['üçï', 'üçî', 'üåØ', 'üå≠', 'üçü', 'ü•§'][Math.floor(Math.random() * 6)];

                card.innerHTML = `
                    <div class="food-image">
                        ${food.image_url ? `<img src="${food.image_url}" style="width:100%;height:100%;object-fit:cover;">` : emoji}
                        ${food.is_new ? '<div class="new-badge">NEW</div>' : ''}
                    </div>
                    <div class="food-info">
                        <div class="food-name">${food.name}</div>
                        <div class="food-desc">${food.description || ''}</div>
                        <div class="food-footer">
                            <div>
                                <div class="food-price">${formatPrice(food.price)}</div>
                                <div class="food-rating">‚≠ê ${food.rating.toFixed(1)}</div>
                            </div>
                            <button class="add-btn" onclick="event.stopPropagation(); addToCart(${JSON.stringify(food).replace(/"/g, '&quot;')})">Add</button>
                        </div>
                    </div>
                `;

                grid.appendChild(card);
            });
        }

        // Filter by Category
        function filterByCategory(categoryId) {
            currentCategory = categoryId;
            
            // Update active button
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.category == categoryId) {
                    btn.classList.add('active');
                }
            });

            applyFilters();
        }

        // Apply Filters
        function applyFilters() {
            let result = [...foods];

            // Filter by category
            if (currentCategory !== 'all') {
                result = result.filter(f => f.category_id == currentCategory);
            }

            // Filter by search
            const search = document.getElementById('searchInput').value.toLowerCase();
            if (search) {
                result = result.filter(f => 
                    f.name.toLowerCase().includes(search) || 
                    (f.description && f.description.toLowerCase().includes(search))
                );
            }

            // Apply sorting
            if (currentSorting === 'rating') {
                result.sort((a, b) => b.rating - a.rating);
            } else if (currentSorting === 'new') {
                result.sort((a, b) => (b.is_new ? 1 : 0) - (a.is_new ? 1 : 0));
            } else if (currentSorting === 'price_asc') {
                result.sort((a, b) => a.price - b.price);
            } else if (currentSorting === 'price_desc') {
                result.sort((a, b) => b.price - a.price);
            }

            filteredFoods = result;
            renderFoods();
        }

        // Apply Sorting
        function applySorting(type) {
            currentSorting = type;
            applyFilters();
            closeFilterModal();
        }

        // Add to Cart
        function addToCart(food) {
            const existing = cart.find(item => item.food_id === food.id);
            
            if (existing) {
                existing.qty++;
            } else {
                cart.push({
                    food_id: food.id,
                    name: food.name,
                    price: food.price,
                    qty: 1
                });
            }

            updateCart();
            tg.HapticFeedback.impactOccurred('light');
        }

        // Update Cart Display
        function updateCart() {
            const total = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            const count = cart.reduce((sum, item) => sum + item.qty, 0);

            document.getElementById('cartCount').textContent = `${count} —Ç–æ–≤–∞—Ä–æ–≤`;
            document.getElementById('cartTotal').textContent = formatPrice(total);

            const cartFloat = document.getElementById('cartFloat');
            const checkoutBtn = document.getElementById('checkoutBtn');

            if (count > 0) {
                cartFloat.style.display = 'block';
                checkoutBtn.disabled = total < 50000;
            } else {
                cartFloat.style.display = 'none';
            }
        }

        // Open Checkout
        document.getElementById('checkoutBtn').addEventListener('click', () => {
            renderCheckoutItems();
            updateCheckoutTotal();
            document.getElementById('checkoutModal').classList.add('active');
        });

        // Render Checkout Items
        function renderCheckoutItems() {
            const container = document.getElementById('checkoutItems');
            container.innerHTML = '';

            cart.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'cart-item';
                div.innerHTML = `
                    <div class="cart-item-info">
                        <div class="cart-item-name">${item.name}</div>
                        <div class="cart-item-price">${formatPrice(item.price)} √ó ${item.qty} = ${formatPrice(item.price * item.qty)}</div>
                    </div>
                    <div class="cart-item-controls">
                        <button class="qty-btn" onclick="changeQty(${index}, -1)">‚àí</button>
                        <div class="qty-display">${item.qty}</div>
                        <button class="qty-btn" onclick="changeQty(${index}, 1)">+</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // Change Quantity
        function changeQty(index, delta) {
            cart[index].qty += delta;
            
            if (cart[index].qty <= 0) {
                cart.splice(index, 1);
            }

            updateCart();
            renderCheckoutItems();
            updateCheckoutTotal();
        }

        // Update Checkout Total
        function updateCheckoutTotal() {
            let total = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);

            if (appliedPromo) {
                total = total * (1 - appliedPromo.discount_percent / 100);
            }

            document.getElementById('checkoutTotal').textContent = formatPrice(total);
        }

        // Validate Promo
        async function validatePromo() {
            const code = document.getElementById('promoInput').value.trim();
            const statusDiv = document.getElementById('promoStatus');

            if (!code) {
                statusDiv.innerHTML = '<div class="promo-error">–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥</div>';
                return;
            }

            try {
                const res = await fetch(`${API_URL}/promo/validate`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({code})
                });

                if (res.ok) {
                    appliedPromo = await res.json();
                    statusDiv.innerHTML = `<div class="promo-success">‚úÖ –°–∫–∏–¥–∫–∞ ${appliedPromo.discount_percent}% –ø—Ä–∏–º–µ–Ω–µ–Ω–∞!</div>`;
                    updateCheckoutTotal();
                } else {
                    statusDiv.innerHTML = '<div class="promo-error">‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∏–ª–∏ –∏—Å—Ç–µ–∫—à–∏–π –ø—Ä–æ–º–æ–∫–æ–¥</div>';
                    appliedPromo = null;
                }
            } catch (error) {
                statusDiv.innerHTML = '<div class="promo-error">‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏</div>';
                appliedPromo = null;
            }
        }

        // Get Location
        function getLocation() {
            const statusDiv = document.getElementById('geoStatus');
            statusDiv.innerHTML = '<div style="color: var(--text-secondary);">‚è≥ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ª–æ–∫–∞—Ü–∏–∏...</div>';

            if (!navigator.geolocation) {
                statusDiv.innerHTML = '<div class="promo-error">‚ùå –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è</div>';
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    statusDiv.innerHTML = `<div class="geo-status">‚úÖ –õ–æ–∫–∞—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞</div>`;
                },
                (error) => {
                    statusDiv.innerHTML = '<div class="promo-error">‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ª–æ–∫–∞—Ü–∏—é</div>';
                    console.error('Geolocation error:', error);
                }
            );
        }

        // Submit Order
        document.getElementById('checkoutForm').addEventListener('submit', (e) => {
            e.preventDefault();

            if (!userLocation) {
                document.getElementById('geoStatus').innerHTML = '<div class="promo-error">‚ùå –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ª–æ–∫–∞—Ü–∏—é</div>';
                return;
            }

            let total = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);

            if (appliedPromo) {
                total = total * (1 - appliedPromo.discount_percent / 100);
            }

            const orderData = {
                type: 'order_create',
                items: cart,
                total: total,
                customer_name: document.getElementById('customerName').value,
                phone: document.getElementById('customerPhone').value,
                comment: document.getElementById('customerComment').value,
                location: userLocation,
                promo_code: appliedPromo ? appliedPromo.code : null,
                created_at_client: new Date().toISOString()
            };

            tg.sendData(JSON.stringify(orderData));
            tg.close();
        });

        // Close Modals
        function closeFilterModal() {
            document.getElementById('filterModal').classList.remove('active');
        }

        function closeCheckoutModal() {
            document.getElementById('checkoutModal').classList.remove('active');
        }

        // Search Input
        document.getElementById('searchInput').addEventListener('input', applyFilters);

        // Settings Button
        document.getElementById('settingsBtn').addEventListener('click', () => {
            document.getElementById('filterModal').classList.add('active');
        });

        // Format Price
        function formatPrice(price) {
            return new Intl.NumberFormat('ru-RU').format(Math.round(price)) + ' —Å—É–º';
        }

        // Phone Mask
        document.getElementById('customerPhone').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            
            if (value.length > 0 && !value.startsWith('998')) {
                value = '998' + value;
            }
            
            if (value.length > 12) {
                value = value.slice(0, 12);
            }
            
            if (value.length >= 3) {
                e.target.value = '+' + value.slice(0, 3) + ' ' + 
                    (value.slice(3, 5) || '') + 
                    (value.length > 5 ? ' ' + value.slice(5, 8) : '') +
                    (value.length > 8 ? ' ' + value.slice(8, 10) : '') +
                    (value.length > 10 ? ' ' + value.slice(10, 12) : '');
            }
        });

        // Init on load
        init();
    </script>
</body>
</html>
