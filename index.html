<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FIESTA ‚Ä¢ WebApp</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#111827;
      --card:#0f172a;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --line:#1f2937;
      --accent:#22c55e;
      --danger:#ef4444;
      --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:980px;margin:0 auto;padding:14px 14px 110px}
    .topbar{display:flex;gap:10px;align-items:center;position:sticky;top:0;background:rgba(11,15,20,.92);backdrop-filter:blur(10px);padding:10px 0;z-index:10}
    .search{flex:1;position:relative}
    .search input{
      width:100%;padding:12px 44px 12px 12px;border:1px solid var(--line);
      border-radius:14px;background:var(--panel);color:var(--text);outline:none;
    }
    .gear{
      position:absolute;right:10px;top:50%;transform:translateY(-50%);
      width:28px;height:28px;border-radius:10px;border:1px solid var(--line);
      display:grid;place-items:center;cursor:pointer;color:var(--muted);background:var(--card);
      user-select:none;
    }
    .cats{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
    .cat{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:var(--panel);color:var(--muted);cursor:pointer}
    .cat.active{border-color:var(--accent);color:var(--text)}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media (min-width:820px){.grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
    .card{
      border:1px solid var(--line);border-radius:16px;background:var(--card);
      padding:12px;display:flex;flex-direction:column;gap:10px;min-height:180px;
    }
    .img{
      height:120px;border-radius:14px;background:linear-gradient(135deg,#1f2937,#0b0f14);
      border:1px solid var(--line);overflow:hidden;display:grid;place-items:center;color:var(--muted);
    }
    .img img{width:100%;height:100%;object-fit:cover}
    .title{font-weight:700}
    .desc{color:var(--muted);font-size:13px;line-height:1.25;min-height:32px}
    .row{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .price{font-weight:800}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);color:var(--muted)}
    .btn{
      padding:10px 12px;border:none;border-radius:12px;background:var(--accent);color:#052e13;
      font-weight:800;cursor:pointer
    }
    .btn:disabled{opacity:.4;cursor:not-allowed}
    .btn-ghost{
      background:transparent;border:1px solid var(--line);color:var(--text)
    }

    /* Cart */
    .cartbar{
      position:fixed;left:0;right:0;bottom:0;background:rgba(17,24,39,.95);
      border-top:1px solid var(--line);backdrop-filter:blur(12px);
      padding:10px 14px;z-index:20;
    }
    .cartbar .inner{max-width:980px;margin:0 auto;display:flex;gap:10px;align-items:center;justify-content:space-between}
    .cartsum{font-weight:900}
    .tiny{font-size:12px;color:var(--muted)}
    .pill{display:flex;gap:8px;align-items:center}

    /* Modal */
    .modalback{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:flex-end;z-index:30}
    .modal{width:100%;background:var(--panel);border:1px solid var(--line);border-radius:18px 18px 0 0;padding:14px}
    .modal h3{margin:0 0 10px}
    .opt{display:flex;gap:10px;align-items:center;padding:10px;border:1px solid var(--line);border-radius:14px;margin:8px 0;cursor:pointer}
    .opt input{accent-color:var(--accent)}
    .form{display:grid;gap:10px;margin-top:10px}
    .form input,.form textarea{
      width:100%;padding:12px;border:1px solid var(--line);border-radius:14px;background:var(--card);color:var(--text);outline:none;
    }
    .form textarea{min-height:80px;resize:vertical}
    .warn{color:var(--warn);font-size:12px}
    .err{color:var(--danger);font-size:12px}
    .ok{color:var(--accent);font-size:12px}
    .hr{height:1px;background:var(--line);margin:10px 0}
    .cartlist{max-height:220px;overflow:auto;border:1px solid var(--line);border-radius:14px;padding:10px;background:var(--card)}
    .itemline{display:flex;justify-content:space-between;gap:10px;margin:8px 0}
    .qtyctrl{display:flex;gap:8px;align-items:center}
    .qbtn{width:28px;height:28px;border-radius:10px;border:1px solid var(--line);background:transparent;color:var(--text);cursor:pointer}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="search">
        <input id="q" placeholder="–ü–æ–∏—Å–∫..." />
        <div class="gear" id="gear">‚öôÔ∏è</div>
      </div>
    </div>

    <div class="cats" id="cats"></div>
    <div class="grid" id="grid"></div>
  </div>

  <div class="cartbar">
    <div class="inner">
      <div class="pill">
        <div>
          <div class="cartsum" id="cartsum">0 —Å—É–º</div>
          <div class="tiny" id="carttiny">–ú–∏–Ω–∏–º—É–º: 50 000 —Å—É–º</div>
        </div>
      </div>
      <button class="btn" id="checkoutBtn" disabled>Checkout</button>
    </div>
  </div>

  <!-- Filter Modal -->
  <div class="modalback" id="filterBack">
    <div class="modal">
      <div class="row">
        <h3>–§–∏–ª—å—Ç—Ä</h3>
        <button class="btn btn-ghost" id="closeFilter">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>

      <label class="opt">
        <input type="radio" name="sort" value="rating">
        <div>
          <div>–†–µ–π—Ç–∏–Ω–≥</div>
          <div class="tiny">–ø–æ —É–±—ã–≤–∞–Ω–∏—é</div>
        </div>
      </label>
      <label class="opt">
        <input type="radio" name="sort" value="new" checked>
        <div>
          <div>–ù–æ–≤—ã–µ</div>
          <div class="tiny">–ø–æ –¥–∞—Ç–µ</div>
        </div>
      </label>
      <label class="opt">
        <input type="radio" name="sort" value="price_asc">
        <div>
          <div>–î–µ—à–µ–≤—ã–µ</div>
          <div class="tiny">—Ü–µ–Ω–∞ ‚Üë</div>
        </div>
      </label>
      <label class="opt">
        <input type="radio" name="sort" value="price_desc">
        <div>
          <div>–î–æ—Ä–æ–≥–∏–µ</div>
          <div class="tiny">—Ü–µ–Ω–∞ ‚Üì</div>
        </div>
      </label>

      <div class="hr"></div>

      <div class="row">
        <div>
          <div class="title">–ö–æ—Ä–∑–∏–Ω–∞</div>
          <div class="tiny">–ù–∞–∂–º–∏—Ç–µ Checkout —á—Ç–æ–±—ã –æ—Ñ–æ—Ä–º–∏—Ç—å</div>
        </div>
      </div>

      <div class="cartlist" id="cartList"></div>

      <div class="hr"></div>

      <div class="form">
        <input id="name" placeholder="–ò–º—è" />
        <input id="phone" placeholder="+998 (__) ___-__-__" />
        <input id="promo" placeholder="–ü—Ä–æ–º–æ–∫–æ–¥ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" />
        <textarea id="comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"></textarea>

        <div class="row">
          <button class="btn btn-ghost" id="geoBtn">üìç –õ–æ–∫–∞—Ü–∏—è–Ω—ã –∞–Ω—ã“õ–ª–∞—É</button>
          <div class="tiny" id="geoStatus">lat/lng: ‚Äî</div>
        </div>

        <div class="warn">–õ–æ–∫–∞—Ü–∏—è (lat/lng) –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞. –ö–∞—Ä—Ç–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.</div>
        <div class="err" id="err"></div>
        <div class="ok" id="ok"></div>

        <button class="btn" id="sendBtn" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</button>
      </div>
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // ‚úÖ FIXED API_BASE (no start_param tricks)
    const API_BASE = "https://uzbke-production.up.railway.app";

    const $ = (id)=>document.getElementById(id);

    const state = {
      categories: [],
      foods: [],
      categoryId: 0,
      q: "",
      sort: "new",
      cart: new Map(), // foodId -> {food, qty}
      geo: {lat:null, lng:null},
      promoOk: null,
      promoPercent: 0
    };

    function fmt(n){ return (n||0).toLocaleString("ru-RU") + " —Å—É–º"; }

    function cartTotal(){
      let s = 0;
      for (const [,v] of state.cart) s += v.food.price * v.qty;
      // discount will be applied server-side too; here only UX
      if (state.promoOk && state.promoPercent>0){
        s = Math.max(0, Math.round(s * (100 - state.promoPercent) / 100));
      }
      return s;
    }

    function renderCats(){
      const wrap = $("cats");
      wrap.innerHTML = "";
      state.categories.forEach(c=>{
        const b = document.createElement("div");
        b.className = "cat" + (c.id===state.categoryId ? " active":"");
        b.textContent = c.name;
        b.onclick = ()=>{ state.categoryId=c.id; loadFoods(); };
        wrap.appendChild(b);
      });
    }

    function renderFoods(){
      const grid = $("grid");
      grid.innerHTML = "";
      state.foods.forEach(f=>{
        const card = document.createElement("div");
        card.className = "card";

        const img = document.createElement("div");
        img.className = "img";
        if (f.image_url){
          const im = document.createElement("img");
          im.src = f.image_url;
          img.appendChild(im);
        } else {
          img.textContent = "No image";
        }

        const t = document.createElement("div");
        t.className = "title";
        t.textContent = f.name;

        const d = document.createElement("div");
        d.className = "desc";
        d.textContent = f.description || "";

        const row = document.createElement("div");
        row.className = "row";

        const left = document.createElement("div");
        left.innerHTML = `<div class="price">${fmt(f.price)}</div>
                          <div class="tiny">‚≠ê ${Number(f.rating||0).toFixed(1)} ${f.is_new ? " ‚Ä¢ NEW":""}</div>`;

        const add = document.createElement("button");
        add.className = "btn";
        add.textContent = "Add";
        add.onclick = ()=> addToCart(f);

        row.appendChild(left);
        row.appendChild(add);

        card.appendChild(img);
        card.appendChild(t);
        card.appendChild(d);
        card.appendChild(row);
        grid.appendChild(card);
      });

      updateCartUI();
    }

    function updateCartUI(){
      const total = cartTotal();
      $("cartsum").textContent = fmt(total);
      $("checkoutBtn").disabled = (total < 50000);
      $("sendBtn").disabled = !(total >= 50000 && state.geo.lat != null && state.geo.lng != null && state.cart.size>0);
      $("carttiny").textContent = state.cart.size ? `–ü–æ–∑–∏—Ü–∏–π: ${state.cart.size}` : "–ú–∏–Ω–∏–º—É–º: 50 000 —Å—É–º";
      renderCartList();
    }

    function renderCartList(){
      const box = $("cartList");
      if (state.cart.size === 0){
        box.innerHTML = `<div class="tiny">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞—è</div>`;
        return;
      }
      box.innerHTML = "";
      for (const [id, v] of state.cart){
        const line = document.createElement("div");
        line.className = "itemline";

        const left = document.createElement("div");
        left.innerHTML = `<div class="title" style="font-size:14px">${v.food.name}</div>
                          <div class="tiny">${fmt(v.food.price)} x ${v.qty} = ${fmt(v.food.price*v.qty)}</div>`;

        const ctrl = document.createElement("div");
        ctrl.className = "qtyctrl";
        const minus = document.createElement("button");
        minus.className = "qbtn";
        minus.textContent = "‚Äì";
        minus.onclick = ()=> setQty(id, v.qty-1);
        const qty = document.createElement("div");
        qty.textContent = v.qty;
        const plus = document.createElement("button");
        plus.className = "qbtn";
        plus.textContent = "+";
        plus.onclick = ()=> setQty(id, v.qty+1);
        ctrl.appendChild(minus); ctrl.appendChild(qty); ctrl.appendChild(plus);

        line.appendChild(left);
        line.appendChild(ctrl);
        box.appendChild(line);
      }
    }

    function addToCart(food){
      const v = state.cart.get(food.id);
      if (v) v.qty += 1;
      else state.cart.set(food.id, {food, qty:1});
      updateCartUI();
    }
    function setQty(foodId, qty){
      if (qty <= 0) state.cart.delete(foodId);
      else state.cart.get(foodId).qty = qty;
      updateCartUI();
    }

    function openFilter(){ $("filterBack").style.display="flex"; }
    function closeFilter(){ $("filterBack").style.display="none"; }

    async function apiGet(path){
      // Telegram initData must be sent as header
      const initData = tg.initData || "";
      const res = await fetch(API_BASE + path, {
        headers: { "X-Tg-Init-Data": initData }
      });
      const data = await res.json();
      if (!res.ok) throw new Error((data && data.detail) ? data.detail : "API error");
      return data;
    }

    async function loadCategories(){
      const data = await apiGet("/api/categories");
      state.categories = data.categories || [];
      renderCats();
    }

    async function loadFoods(){
      const qs = new URLSearchParams();
      if ($("q").value.trim()) qs.set("q", $("q").value.trim());
      if (state.categoryId) qs.set("category_id", String(state.categoryId));
      qs.set("sort", state.sort);

      const data = await apiGet("/api/foods?" + qs.toString());
      state.foods = data.foods || [];
      renderCats();
      renderFoods();
    }

    function maskPhone(v){
      // very simple mask for +998
      let digits = (v||"").replace(/\D/g,"");
      if (digits.startsWith("998")) digits = digits.slice(3);
      digits = digits.slice(0,9);
      const a = digits.slice(0,2);
      const b = digits.slice(2,5);
      const c = digits.slice(5,7);
      const d = digits.slice(7,9);
      let out = "+998";
      if (a) out += " ("+a;
      if (a && a.length===2) out += ")";
      if (b) out += " "+b;
      if (c) out += "-"+c;
      if (d) out += "-"+d;
      return out;
    }

    async function validatePromo(){
      const code = $("promo").value.trim();
      $("err").textContent = "";
      $("ok").textContent = "";
      state.promoOk = null;
      state.promoPercent = 0;
      if (!code){
        updateCartUI();
        return;
      }
      try{
        const data = await apiGet("/api/promo/validate?code="+encodeURIComponent(code));
        if (data.ok){
          state.promoOk = true;
          state.promoPercent = data.discount_percent || 0;
          $("ok").textContent = `–ü—Ä–æ–º–æ–∫–æ–¥ OK: —Å–∫–∏–¥–∫–∞ ${state.promoPercent}%`;
        } else {
          state.promoOk = false;
          $("err").textContent = "–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω: " + (data.reason || "–æ—à–∏–±–∫–∞");
        }
      }catch(e){
        $("err").textContent = String(e.message||e);
      }
      updateCartUI();
    }

    function collectItems(){
      const arr = [];
      for (const [,v] of state.cart){
        arr.push({
          food_id: v.food.id,
          name: v.food.name,
          qty: v.qty,
          price: v.food.price
        });
      }
      return arr;
    }

    function sendOrder(){
      $("err").textContent = "";
      $("ok").textContent = "";
      const total = cartTotal();
      if (total < 50000){
        $("err").textContent = "–ú–∏–Ω–∏–º—É–º 50 000 —Å—É–º";
        return;
      }
      if (state.geo.lat == null || state.geo.lng == null){
        $("err").textContent = "–õ–æ–∫–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞";
        return;
      }
      const payload = {
        type: "order_create",
        items: collectItems(),
        total: total,
        customer_name: $("name").value.trim() || (tg.initDataUnsafe?.user?.first_name || "User"),
        phone: $("phone").value.trim(),
        comment: $("comment").value.trim(),
        promo_code: $("promo").value.trim() || null,
        location: { lat: state.geo.lat, lng: state.geo.lng },
        created_at_client: new Date().toISOString(),
      };
      tg.sendData(JSON.stringify(payload));
      tg.close();
    }

    // EVENTS
    $("gear").onclick = openFilter;
    $("closeFilter").onclick = closeFilter;
    $("filterBack").onclick = (e)=>{ if (e.target.id==="filterBack") closeFilter(); };

    document.querySelectorAll('input[name="sort"]').forEach(r=>{
      r.onchange = ()=>{
        state.sort = document.querySelector('input[name="sort"]:checked').value;
        loadFoods();
      };
    });

    $("q").addEventListener("input", ()=>{
      clearTimeout(window.__t);
      window.__t = setTimeout(()=>loadFoods(), 250);
    });

    $("checkoutBtn").onclick = ()=>{
      // prefill name with telegram
      $("name").value = $("name").value || (tg.initDataUnsafe?.user?.first_name || "") + " " + (tg.initDataUnsafe?.user?.last_name || "");
      openFilter();
      updateCartUI();
    };

    $("geoBtn").onclick = ()=>{
      $("err").textContent = "";
      $("ok").textContent = "";
      if (!navigator.geolocation){
        $("err").textContent = "Geolocation not supported";
        return;
      }
      $("geoStatus").textContent = "–û–ø—Ä–µ–¥–µ–ª—è–µ–º...";
      navigator.geolocation.getCurrentPosition(
        (pos)=>{
          state.geo.lat = pos.coords.latitude;
          state.geo.lng = pos.coords.longitude;
          $("geoStatus").textContent = `lat/lng: ${state.geo.lat.toFixed(6)}, ${state.geo.lng.toFixed(6)}`;
          $("ok").textContent = "–õ–æ–∫–∞—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∞ ‚úÖ";
          updateCartUI();
        },
        (err)=>{
          $("geoStatus").textContent = "lat/lng: ‚Äî";
          $("err").textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ª–æ–∫–∞—Ü–∏—é: " + err.message;
        },
        { enableHighAccuracy:true, timeout:10000 }
      );
    };

    $("phone").addEventListener("input", (e)=>{
      e.target.value = maskPhone(e.target.value);
    });

    $("promo").addEventListener("change", validatePromo);

    $("sendBtn").onclick = sendOrder;

    // INIT
    (async ()=>{
      try{
        await loadCategories();
        await loadFoods();
      }catch(e){
        $("grid").innerHTML = `<div class="err">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${String(e.message||e)}</div>`;
      }
    })();
  </script>
</body>
</html>
