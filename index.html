<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FIESTA ‚Äî Food Delivery</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#0b0f14; --card:#111827; --muted:#94a3b8; --text:#e5e7eb;
      --accent:#22c55e; --danger:#ef4444; --border:#1f2937; --chip:#0f172a;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,var(--bg),rgba(11,15,20,.65));backdrop-filter:blur(8px);padding:14px 14px 8px;border-bottom:1px solid var(--border)}
    .row{display:flex;gap:10px;align-items:center}
    .searchWrap{flex:1;position:relative}
    input[type="search"]{
      width:100%;padding:12px 44px 12px 12px;border-radius:14px;
      border:1px solid var(--border);background:#0f172a;color:var(--text);
      outline:none;
    }
    .gear{
      position:absolute;right:10px;top:50%;transform:translateY(-50%);
      width:34px;height:34px;border-radius:12px;border:1px solid var(--border);
      background:rgba(255,255,255,.03);display:grid;place-items:center;cursor:pointer;
    }
    .gear:hover{border-color:#334155}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .tab{
      padding:8px 10px;border:1px solid var(--border);border-radius:999px;background:var(--chip);
      color:var(--muted);cursor:pointer;font-size:13px;
    }
    .tab.active{color:var(--text);border-color:#334155}
    main{padding:14px; padding-bottom:120px}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    .card{
      background:var(--card);border:1px solid var(--border);border-radius:18px;padding:12px;
      box-shadow:var(--shadow);display:flex;flex-direction:column;gap:10px;min-height:170px;
    }
    .title{font-weight:700;font-size:14px;line-height:1.2}
    .desc{color:var(--muted);font-size:12px;line-height:1.2;min-height:28px}
    .meta{display:flex;justify-content:space-between;align-items:center}
    .price{font-weight:800}
    .rating{color:#fbbf24;font-size:12px}
    .btn{
      border:0;border-radius:14px;padding:10px 12px;font-weight:700;cursor:pointer;
      background:rgba(34,197,94,.12);color:var(--accent);border:1px solid rgba(34,197,94,.25);
    }
    .btn:active{transform:scale(.99)}
    .btn.danger{background:rgba(239,68,68,.12);color:var(--danger);border-color:rgba(239,68,68,.25)}
    .cartFab{
      position:fixed;left:14px;right:14px;bottom:14px;z-index:10;
      background:rgba(17,24,39,.9);border:1px solid var(--border);border-radius:20px;
      box-shadow:var(--shadow);padding:12px;display:flex;gap:10px;align-items:center;
    }
    .cartInfo{flex:1}
    .cartTotal{font-weight:900}
    .small{color:var(--muted);font-size:12px}
    .checkout{min-width:120px}
    .checkout[disabled]{opacity:.45;cursor:not-allowed}
    .modalBackdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;z-index:50;
      align-items:flex-end;
    }
    .modal{
      width:100%;background:var(--card);border-top:1px solid var(--border);
      border-radius:18px 18px 0 0;padding:14px;box-shadow:var(--shadow)
    }
    .modal h3{margin:0 0 10px 0}
    .modal .opt{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px dashed #1f2937}
    .modal .opt:last-child{border-bottom:0}
    .modal .opt button{padding:8px 10px;border-radius:12px;border:1px solid var(--border);background:#0f172a;color:var(--text);cursor:pointer}
    .sheetBackdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;z-index:60;align-items:flex-end;
    }
    .sheet{
      width:100%;max-height:85vh;overflow:auto;background:var(--card);border-top:1px solid var(--border);
      border-radius:18px 18px 0 0;padding:14px;box-shadow:var(--shadow)
    }
    .sheet h3{margin:0 0 10px 0}
    .field{display:flex;flex-direction:column;gap:6px;margin:10px 0}
    .field label{color:var(--muted);font-size:12px}
    .field input,.field textarea{
      background:#0f172a;border:1px solid var(--border);border-radius:14px;padding:12px;color:var(--text);outline:none;
    }
    .sheetActions{display:flex;gap:10px;margin-top:12px}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:var(--chip);color:var(--muted);font-size:12px}
    .warn{color:#fca5a5}
  </style>
</head>
<body>
<header>
  <div class="row">
    <div class="searchWrap">
      <input id="search" type="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –º–µ–Ω—é..." />
      <div class="gear" id="openFilter" title="–§–∏–ª—å—Ç—Ä">‚öôÔ∏è</div>
    </div>
  </div>
  <div class="tabs" id="tabs"></div>
</header>

<main>
  <div class="row" style="justify-content:space-between;margin-bottom:10px;">
    <div class="pill" id="pillStatus">–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–Ω—é‚Ä¶</div>
    <div class="pill" id="pillSort">–°–æ—Ä—Ç: –ø–æ —É–º–æ–ª—á.</div>
  </div>
  <div class="grid" id="grid"></div>
</main>

<div class="cartFab">
  <div class="cartInfo">
    <div class="cartTotal" id="cartTotal">0 —Å—É–º</div>
    <div class="small" id="cartItems">0 —Ç–æ–≤–∞—Ä–æ–≤ ‚Ä¢ –º–∏–Ω–∏–º—É–º 50 000</div>
  </div>
  <button class="btn checkout" id="checkoutBtn" disabled>Checkout</button>
</div>

<!-- Filter Modal -->
<div class="modalBackdrop" id="filterBackdrop">
  <div class="modal">
    <h3>–§–∏–ª—å—Ç—Ä</h3>
    <div class="opt"><div>–†–µ–π—Ç–∏–Ω–≥ –ø–æ —É–±—ã–≤–∞–Ω–∏—é</div><button data-sort="rating_desc">–í—ã–±—Ä–∞—Ç—å</button></div>
    <div class="opt"><div>–ù–æ–≤—ã–µ –±–ª—é–¥–∞</div><button data-sort="created_desc">–í—ã–±—Ä–∞—Ç—å</button></div>
    <div class="opt"><div>–ê—Ä–∑–æ–Ω</div><button data-sort="price_asc">–í—ã–±—Ä–∞—Ç—å</button></div>
    <div class="opt"><div>Qimmat</div><button data-sort="price_desc">–í—ã–±—Ä–∞—Ç—å</button></div>
    <div style="display:flex;gap:10px;margin-top:10px;">
      <button class="btn danger" id="closeFilter" style="flex:1;">–ó–∞–∫—Ä—ã—Ç—å</button>
      <button class="btn" id="resetFilter" style="flex:1;">–°–±—Ä–æ—Å</button>
    </div>
  </div>
</div>

<!-- Checkout Sheet -->
<div class="sheetBackdrop" id="sheetBackdrop">
  <div class="sheet">
    <h3>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h3>
    <div class="pill" id="minWarn">–ú–∏–Ω–∏–º—É–º 50 000 —Å—É–º</div>

    <div class="field">
      <label>–ò–º—è</label>
      <input id="custName" type="text" />
    </div>

    <div class="field">
      <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
      <input id="phone" type="tel" placeholder="+998 (__) ___-__-__" />
    </div>

    <div class="field">
      <label>–ü—Ä–æ–º–æ–∫–æ–¥ (–µ—Å–ª–∏ –µ—Å—Ç—å)</label>
      <input id="promo" type="text" placeholder="FIESTA10" />
      <div class="small" id="promoHint"></div>
    </div>

    <div class="field">
      <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
      <textarea id="comment" rows="3" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –±–µ–∑ –ª—É–∫–∞"></textarea>
    </div>

    <div class="field">
      <label>üìç –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ lat/lng)</label>
      <button class="btn" id="geoBtn">–õ–æ–∫–∞—Ü–∏—è–Ω—ã –∞–Ω—ã“õ–ª–∞—É</button>
      <div class="small" id="geoHint">–ù–µ—Ç –ª–æ–∫–∞—Ü–∏–∏</div>
    </div>

    <div class="sheetActions">
      <button class="btn danger" id="closeSheet" style="flex:1;">–ó–∞–∫—Ä—ã—Ç—å</button>
      <button class="btn" id="sendOrder" style="flex:1;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
    <div class="small warn" id="errBox" style="margin-top:10px;"></div>
  </div>
</div>

<script>
(function(){
  const tg = window.Telegram.WebApp;
  tg.expand();
  const initData = tg.initData || "";

  // IMPORTANT: set your API base (FastAPI domain)
  // Example: https://uzbke-production.up.railway.app
  const API_BASE = (tg.initDataUnsafe?.start_param && tg.initDataUnsafe.start_param.startsWith("api="))
    ? decodeURIComponent(tg.initDataUnsafe.start_param.slice(4))
    : (window.API_BASE_OVERRIDE || "https://uzbke-production.up.railway.app");

  const categoriesFixed = ["All","Lavash","Burger","Xaggi","Shaurma","Hotdog","Combo","Sneki","Sous","Napitki"];
  let categories = [];
  let foods = [];
  let activeCategoryName = "All";
  let activeCategoryId = null;
  let sortMode = "";
  let query = "";

  const cart = new Map(); // food_id -> {food, qty}

  let location = null;

  const $ = (id)=>document.getElementById(id);
  const tabs = $("tabs");
  const grid = $("grid");
  const pillStatus = $("pillStatus");
  const pillSort = $("pillSort");
  const search = $("search");
  const cartTotalEl = $("cartTotal");
  const cartItemsEl = $("cartItems");
  const checkoutBtn = $("checkoutBtn");

  const filterBackdrop = $("filterBackdrop");
  const openFilter = $("openFilter");
  const closeFilter = $("closeFilter");
  const resetFilter = $("resetFilter");

  const sheetBackdrop = $("sheetBackdrop");
  const closeSheet = $("closeSheet");
  const sendOrder = $("sendOrder");
  const geoBtn = $("geoBtn");
  const geoHint = $("geoHint");
  const custName = $("custName");
  const phone = $("phone");
  const comment = $("comment");
  const promo = $("promo");
  const promoHint = $("promoHint");
  const errBox = $("errBox");

  function fmtMoney(n){
    try { return (n||0).toString().replace(/\B(?=(\d{3})+(?!\d))/g," "); }
    catch(e){ return String(n||0); }
  }

  function computeTotal(){
    let total = 0;
    let count = 0;
    for (const [id, it] of cart.entries()){
      total += it.food.price * it.qty;
      count += it.qty;
    }
    return {total, count};
  }

  function renderCartBar(){
    const {total, count} = computeTotal();
    cartTotalEl.textContent = fmtMoney(total) + " —Å—É–º";
    cartItemsEl.textContent = count + " —Ç–æ–≤–∞—Ä–æ–≤ ‚Ä¢ –º–∏–Ω–∏–º—É–º 50 000";
    checkoutBtn.disabled = total < 50000;
  }

  function renderTabs(){
    tabs.innerHTML = "";
    const allNames = categoriesFixed; // keep exact list
    for (const name of allNames){
      const div = document.createElement("div");
      div.className = "tab" + (name === activeCategoryName ? " active":"");
      div.textContent = name;
      div.onclick = ()=>{
        activeCategoryName = name;
        const cat = categories.find(c=>c.name === name);
        activeCategoryId = (name === "All") ? null : (cat ? cat.id : null);
        renderTabs();
        loadFoods();
      };
      tabs.appendChild(div);
    }
  }

  function card(food){
    const el = document.createElement("div");
    el.className = "card";
    const t = document.createElement("div");
    t.className = "title";
    t.textContent = food.name + (food.is_new ? " ‚Ä¢ NEW":"");
    const d = document.createElement("div");
    d.className = "desc";
    d.textContent = food.description || "";
    const meta = document.createElement("div");
    meta.className = "meta";
    const price = document.createElement("div");
    price.className = "price";
    price.textContent = fmtMoney(food.price) + " —Å—É–º";
    const rating = document.createElement("div");
    rating.className = "rating";
    rating.textContent = "‚òÖ " + (food.rating || 0);
    meta.appendChild(price);
    meta.appendChild(rating);

    const add = document.createElement("button");
    add.className = "btn";
    add.textContent = "Add";
    add.onclick = ()=>{
      const current = cart.get(food.id);
      if (current) current.qty += 1;
      else cart.set(food.id, {food, qty:1});
      renderCartBar();
      tg.HapticFeedback?.impactOccurred("light");
    };

    el.appendChild(t);
    el.appendChild(d);
    el.appendChild(meta);
    el.appendChild(add);
    return el;
  }

  function renderFoods(){
    grid.innerHTML = "";
    if (!foods.length){
      pillStatus.textContent = "–ú–µ–Ω—é –ø—É—Å—Ç–æ";
      return;
    }
    pillStatus.textContent = "–ì–æ—Ç–æ–≤–æ";
    for (const f of foods){
      grid.appendChild(card(f));
    }
  }

  async function apiGet(path){
    const res = await fetch(API_BASE + path, {
      headers: { "X-Tg-Init-Data": initData }
    });
    if (!res.ok){
      const t = await res.text();
      throw new Error("API " + res.status + ": " + t);
    }
    return await res.json();
  }

  async function loadCategories(){
    try{
      const data = await apiGet("/api/categories");
      categories = data.categories || [];
    }catch(e){
      // still render fixed tabs even if API fails
      categories = [];
      console.log(e);
    }
  }

  async function loadFoods(){
    try{
      pillStatus.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–Ω—é‚Ä¶";
      let path = "/api/foods?";

      if (activeCategoryId) path += "category_id=" + encodeURIComponent(activeCategoryId) + "&";
      if (query) path += "q=" + encodeURIComponent(query) + "&";
      if (sortMode) path += "sort=" + encodeURIComponent(sortMode) + "&";

      const data = await apiGet(path);
      foods = data.foods || [];
      renderFoods();
    }catch(e){
      pillStatus.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏";
      grid.innerHTML = "";
      const div = document.createElement("div");
      div.className = "pill";
      div.textContent = "API error. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API_BASE –∏ initData.";
      grid.appendChild(div);
      console.log(e);
    }
  }

  // Filter modal
  openFilter.onclick = ()=> filterBackdrop.style.display="flex";
  closeFilter.onclick = ()=> filterBackdrop.style.display="none";
  resetFilter.onclick = ()=>{
    sortMode = "";
    pillSort.textContent = "–°–æ—Ä—Ç: –ø–æ —É–º–æ–ª—á.";
    filterBackdrop.style.display="none";
    loadFoods();
  };
  filterBackdrop.addEventListener("click",(e)=>{
    if (e.target === filterBackdrop) filterBackdrop.style.display="none";
  });
  filterBackdrop.querySelectorAll("button[data-sort]").forEach(btn=>{
    btn.onclick = ()=>{
      sortMode = btn.getAttribute("data-sort");
      const map = {
        "rating_desc":"—Ä–µ–π—Ç–∏–Ω–≥ ‚Üì",
        "created_desc":"–Ω–æ–≤—ã–µ ‚Üì",
        "price_asc":"—Ü–µ–Ω–∞ ‚Üë",
        "price_desc":"—Ü–µ–Ω–∞ ‚Üì",
      };
      pillSort.textContent = "–°–æ—Ä—Ç: " + (map[sortMode] || sortMode);
      filterBackdrop.style.display="none";
      loadFoods();
    };
  });

  // Search
  let searchTimer = null;
  search.addEventListener("input", ()=>{
    clearTimeout(searchTimer);
    searchTimer = setTimeout(()=>{
      query = (search.value || "").trim();
      loadFoods();
    }, 300);
  });

  // Checkout sheet
  checkoutBtn.onclick = ()=>{
    errBox.textContent = "";
    sheetBackdrop.style.display="flex";
    const u = tg.initDataUnsafe?.user;
    custName.value = (custName.value || u?.first_name || u?.username || "–ö–ª–∏–µ–Ω—Ç");
  };
  closeSheet.onclick = ()=> sheetBackdrop.style.display="none";
  sheetBackdrop.addEventListener("click",(e)=>{
    if (e.target === sheetBackdrop) sheetBackdrop.style.display="none";
  });

  // Phone mask (simple)
  phone.addEventListener("input", ()=>{
    let v = phone.value.replace(/[^\d+]/g,"");
    if (!v.startsWith("+")) v = "+998" + v.replace(/^\d+/,"");
    phone.value = v.slice(0, 13);
  });

  // Promo validate on blur
  promo.addEventListener("blur", async ()=>{
    promoHint.textContent = "";
    const code = (promo.value || "").trim();
    if (!code) return;
    try{
      const data = await apiGet("/api/promo/validate?code=" + encodeURIComponent(code));
      if (data.ok){
        promoHint.textContent = "‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥: -" + data.discount_percent + "%";
      } else {
        promoHint.textContent = "‚ùå –ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω";
      }
    }catch(e){
      promoHint.textContent = "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥";
    }
  });

  // Geo
  geoBtn.onclick = ()=>{
    errBox.textContent = "";
    if (!navigator.geolocation){
      geoHint.textContent = "–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞";
      return;
    }
    geoHint.textContent = "–ü–æ–ª—É—á–∞–µ–º –ª–æ–∫–∞—Ü–∏—é‚Ä¶";
    navigator.geolocation.getCurrentPosition((pos)=>{
      location = {
        lat: +pos.coords.latitude.toFixed(6),
        lng: +pos.coords.longitude.toFixed(6),
      };
      geoHint.textContent = "‚úÖ " + location.lat + ", " + location.lng;
      tg.HapticFeedback?.notificationOccurred("success");
    }, (err)=>{
      geoHint.textContent = "‚ùå –û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏";
    }, {enableHighAccuracy:true, timeout:10000});
  };

  // Send order to bot via sendData(JSON)
  sendOrder.onclick = ()=>{
    errBox.textContent = "";
    const {total, count} = computeTotal();
    if (total < 50000){
      errBox.textContent = "–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞: 50 000 —Å—É–º.";
      return;
    }
    if (!location){
      errBox.textContent = "–ù—É–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ª–æ–∫–∞—Ü–∏—é (lat/lng).";
      return;
    }
    const items = [];
    for (const [id, it] of cart.entries()){
      items.push({
        food_id: it.food.id,
        name: it.food.name,
        qty: it.qty,
        price: it.food.price
      });
    }
    const payload = {
      type: "order_create",
      items,
      total,
      customer_name: (custName.value || "").trim(),
      phone: (phone.value || "").trim(),
      comment: (comment.value || "").trim(),
      promo_code: (promo.value || "").trim(),
      location,
      created_at_client: new Date().toISOString()
    };
    try{
      tg.sendData(JSON.stringify(payload));
      tg.close();
    }catch(e){
      errBox.textContent = "–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.";
    }
  };

  // Init
  (async ()=>{
    renderTabs();
    renderCartBar();
    await loadCategories();
    renderTabs();
    await loadFoods();
  })();
})();
</script>
</body>
</html>
